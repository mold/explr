"use strict";function _createForOfIteratorHelper(e,t){var n,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),n=0,{s:t=function(){},n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,i=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return o=e.done,e},e:function(e){i=!0,r=e},f:function(){try{o||null==a.return||a.return()}finally{if(i)throw r}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function ownKeys(t,e){var n,a=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)),a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var a,r,o=[],i=!0,s=!1;try{for(n=n.call(e);!(i=(a=n.next()).done)&&(o.push(a.value),!t||o.length!==t);i=!0);}catch(e){s=!0,r=e}finally{try{i||null==n.return||n.return()}finally{if(s)throw r}}return o}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}var announcer={},LIVEREGION_TIMEOUT_DELAY=7e3,liveAnnouncer=null;function debounce(a,r){var o;return function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];clearTimeout(o),o=setTimeout(function(){clearTimeout(o),a.apply(void 0,t)},r)}}function announce(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"assertive",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:LIVEREGION_TIMEOUT_DELAY;(liveAnnouncer=liveAnnouncer||new LiveAnnouncer).announce(e,t,n)}function clearAnnouncer(e){liveAnnouncer&&liveAnnouncer.clear(e)}function destroyAnnouncer(){liveAnnouncer&&(liveAnnouncer.destroy(),liveAnnouncer=null)}var LiveAnnouncer=function(){function e(){_classCallCheck(this,e),this.node=document.createElement("div"),this.node.dataset.liveAnnouncer="true",Object.assign(this.node.style,{border:0,clip:"rect(0 0 0 0)",clipPath:"inset(50%)",height:"1px",margin:"-1px",overflow:"hidden",padding:0,position:"absolute",width:"1px",whiteSpace:"nowrap"}),this.assertiveLog=this.createLog("assertive"),this.node.appendChild(this.assertiveLog),this.politeLog=this.createLog("polite"),this.node.appendChild(this.politeLog),document.body.prepend(this.node)}return _createClass(e,[{key:"createLog",value:function(e){var t=document.createElement("div");return t.setAttribute("role","log"),t.setAttribute("aria-live",e),t.setAttribute("aria-relevant","additions"),t}},{key:"destroy",value:function(){this.node&&(document.body.removeChild(this.node),this.node=null)}},{key:"announce",value:function(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"assertive",a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:LIVEREGION_TIMEOUT_DELAY;this.node&&((t=document.createElement("div")).textContent=e,("assertive"===n?this.assertiveLog:this.politeLog).appendChild(t),""!==e&&setTimeout(function(){t.remove()},a))}},{key:"clear",value:function(e){this.node&&(e&&"assertive"!==e||(this.assertiveLog.innerHTML=""),e&&"polite"!==e||(this.politeLog.innerHTML=""))}}]),e}();announcer.announce=announce,announcer.clearAnnouncer=clearAnnouncer,announcer.destroyAnnouncer=destroyAnnouncer,announcer.debounce=debounce;(api=api||{}).lastfm={},api.lastfm.key="865b1653dbe200905a5b75d9d839467a",api.lastfm.url="https://ws.audioscrobbler.com/2.0/",function(f){function h(e,t){v[e].total++,v[e].success+=t?1:0,v[e].fails+=t?0:1}var g=0,y=["7a9619a850ccf7377c46cf233c51e3c6","13893ba930c63b1b2cbe21441dc7f550","4cb074e4b8ec4ee9ad3eb37d6f7eb240","4a9f5581a9cdf20a699f540ac52a95c9","57ee3318536b23ee81d6b27e36997cde","865b1653dbe200905a5b75d9d839467a","68b2125fd8f8fbadeb2195e551f32bc4","1ba315d4d1673bbf88aed473f1917306"],v=window.keyInfo={};y.forEach(function(e){return v[e]={success:0,fails:0,total:0}});f.lastfm.send=function(i,s,e,c){c=void 0===c?10:c;var l,d,u=!1;function p(a,r){t=y.reduce(function(e,t,n,a){return e+v[t].fails/a.length},0);var t,e,n,o=(e=(e=y.filter(function(e){return v[e].fails<=t})).length?e:y)[++g%e.length];l=d3.json((n=f.lastfm.url+"?method="+i+"&api_key="+o+"&format=json",s.forEach(function(e){n+="&"+e[0]+"="+(e[1]+"").replace("&","%26").replace("/","%2F").replace("+","%2B").replace("\\","%5C")}),n),function(e,t){if(u)clearTimeout(m);else{if(e?t=JSON.parse(e.response):t.error&&(e=t),e){h(o,!1);var n={method:i,errorCode:e&&e.error,try:a,options:s,key:o,message:e.message||(null===(n=JSON.parse(e.response))||void 0===n?void 0:n.message)};if(a<c)return console.warn("Retry request: ",n),void setTimeout(p.bind(null,a+1,r),3e3*a);c<=a&&(console.warn("Retry failed after "+c+" attempts, will stop trying.",n),clearTimeout(m),u=!0,e="ERROR",t={error:"Took to long to respond"})}else h(o,!0);d=!0,r(e,t)}})}p(0,e);var m=setTimeout(function(){d||(l.abort(),e("ERROR",{error:"Took to long to respond"}))},2e4);return{abort:function(){u=!0,l.abort()}}}}(api);var typingTimeout,api=api||{},superCount=0,utils=(!function(){api.getCountriesData=(console.log("Loading countries data..."),function(){return e=e||new Promise(function(n,e){d3.csv("assets/data/countries.csv",function(e,t){t.forEach(function(e){e.id=+e.id,e.names=e.names?e.names.split("|"):[],e.tags=e.tags?e.tags.split("|"):[],e.mainName=e.names[0],e.tag=e.tags[0],e.name=e.mainName}),n(t)})})}),Promise.all([api.getCountriesData(),new Promise(function(n,a){return d3.json("assets/data/artist-countries.json",function(e,t){return e?a(e):n(t)})})]).then(function(e){var e=_slicedToArray(e,2),t=e[0],n=e[1],t=t.map(function(t){var e=[];return 1===t.names.length&&0===t.tags.length&&(e=[t]),1<t.names.length&&(e=e.concat(t.names.map(function(e){return _objectSpread(_objectSpread({},t),{},{name:e})}))),0<t.tags.length&&(e=e.concat(t.tags.map(function(e){return _objectSpread(_objectSpread({},t),{},{tag:e})}))),1<t.names.length&&0<t.tags.length&&e.splice(0,1),e}).flat(),s=d3.nest().key(function(e){return e&&e.tag?e.tag.toLowerCase():""}).map(t),c=d3.nest().key(function(e){return e.name.toLowerCase()}).map(t);api.getCountry=function(o,i){var e;if(n[o])return e=n[o].toLowerCase(),console.log('Using hardcoded country tag "'.concat(e,'" for artist "').concat(o,'"')),void i({artist:o,tag:e,id:c[e][0].id,country:c[e][0].mainName});api.lastfm.send("artist.gettoptags",[["artist",o]],function(e,t){var a,r,n;!e&&t.toptags&&t.toptags.tag&&t.toptags.tag.length?(e=[].concat(["georgia","ireland"],["spanish","french","english","portuguese","russian","italian","japanese","korean","indian","swedish","irish"]),r=a={tag:"",id:null,country:"",count:0},t.toptags.tag.some(function(e,t){var n=e.name.toLowerCase();if(r.id&&a.id)return!0;try{!r.id&&c[n]&&c[n][0].id&&(r={tag:n,id:c[n][0].id,country:c[n][0].mainName,count:e.count}),!a.id&&s[n]&&s[n][0].id&&(a={tag:n,id:s[n][0].id,country:s[n][0].name,count:e.count})}catch(e){}}),n=r.id&&a.count<8*r.count?r:a.id?a:{},"georgia"===r.tag&&t.toptags.tag.some(function(e){return["american","us","usa"].includes(e.name.toLowerCase())})&&(n=a,console.info("'"+o+"' is tagged with 'georgia', but I'm gonna go ahead and guess they're really from the U.S.")),e.includes(n.tag)&&console.info("Potentially incorrect country for '"+o+"': "+n.country+", using the tag '"+n.tag+"'"),i(Object.assign({artist:o},n))):i({artist:o})})},api.getCountries=function(e,t){function a(){n++,superCount++,script.setLoadingStatus("Loading artists, please wait... (".concat(superCount," / ").concat(SESSION.total_artists,")")),d3.select("#loading-text").html("Loading artists...<br>("+superCount+"/"+SESSION.total_artists+")<br>You can start exploring,<br>but it might interfere<br>with loading your artists."),n===e.length&&localforage.setItem("artists",STORED_ARTISTS,function(e){e&&console.error("Failed saving artists to storage: ",e),t(r)})}var r=[],n=0;e.forEach(function(t,e){var n;STORED_ARTISTS[t]&&STORED_ARTISTS[t].country?((n=STORED_ARTISTS[t].country).artist=t,r.push(n),a()):((new Date).getTime(),api.getCountry(t,function(e){STORED_ARTISTS[t]=STORED_ARTISTS[t]||{},STORED_ARTISTS[t].country={id:e.id,name:e.name},r.push(e),a()}))})}}),api.getTags=function(n,a){STORED_ARTISTS[n]&&STORED_ARTISTS[n].tags?a(STORED_ARTISTS[n].tags):(STORED_ARTISTS[n]=STORED_ARTISTS[n]||{},STORED_ARTISTS[n].tags=[],api.lastfm.send("artist.gettoptags",[["artist",n]],function(e,t){STORED_ARTISTS[n].tags=t.toptags.tag,localforage.setItem("artists",STORED_ARTISTS,function(e){e&&console.error("Failed saving artists to storage: ",e),a(STORED_ARTISTS[n].tags)})}))},api.getArtistInfo=function(a,r){var o=[];api.lastfm.send("artist.getinfo",[["artist",a]],function(e,t){var n=[];t.artist.tags.tag&&t.artist.tags.tag.forEach(function(e,t){n.push(e.name)}),o.push({name:a,url:t.artist.url,image:t.artist.image[3]["#text"],description:t.artist.bio.summary,tags:n}),r(o)})};var e,n=[];api.cancelRecommendationRequests=function(){n.forEach(function(e){e.abort()}),n=[]},api.getRecommendations=function(c,l){api.cancelRecommendationRequests();var d=[],e=USER_TAGS.slice(0,15),u=d3.nest().key(function(e){return e.tag}).rollup(function(e){return e[0].count}).map(e),e=api.lastfm.send("tag.gettopartists",[["tag",c],["limit",100]],function(e,t){var i,s={};!e&&!t.error&&t.topartists&&t.topartists.artist?(i=t.topartists.artist).forEach(function(r,o){s[r.name]=[];var e=api.lastfm.send("artist.gettoptags",[["artist",r.name]],function(e,t){var n=!t.error&&!!t.toptags.tag;if((d3.select("#rec-loading-current").html("("+r.name+")"),n)&&d3.nest().key(function(e){return e.name}).map(t.toptags.tag)[c])for(var a=t.toptags.tag.length-1;0<=a;a--)u[t.toptags.tag[a].name]&&5<t.toptags.tag[a].count&&s[r.name].push(t.toptags.tag[a].name);o===i.length-1&&(d3.keys(s).forEach(function(e){d.push({name:e,count:s[e].length,tags:s[e]})}),d.sort(function(e,t){return t.count<e.count?-1:t.count>e.count?1:0}),l(d))});n.push(e)}):l([])});n.push(e)},api.getFriends=function(e){api.lastfm.send("user.getFriends",[["user",SESSION.name]],e)}}((window,document)),utils||{}),screenshot=(utils.exportToCSV=function(n){var e=map.countryNames.map(function(e){var t=n[e.id];return{countryId:e.id,countryName:e.mainName,artists:t&&t[SESSION.name]||[]}}),e="data:text/csv;charset=utf-8,"+(e=json2csv.parse(e.sort(function(e,t){e=e.countryName,t=t.countryName;return e.localeCompare(t,"en")}),{fields:[{label:"Country",value:"countryName"},{label:"Number of artists",value:function(e){return e.artists.length}},{label:"Scrobbles",value:function(e){return e.artists.reduce(function(e,t){return e+t.playcount},0)}}]})).replaceAll('"',"");window.open(encodeURI(e))},utils.getCountryNameFromId=function(t){var e=map.countryNames.find(function(e){return e.id===t});return e&&e.mainName?e.mainName:""},utils.getNumberOfArtistsForCountry=function(t){var e=script.getCurrentData(),n=(n=[]).concat.apply(n,_toConsumableArray(Object.values(e)));(n=n.reduce(function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e=e.concat(t[n]));return e},[])).filter(function(e){return e.id===t});return n.filter(function(e){return e.id===t}).length},{}),search=(!function(t,u){screenshot.render=function(){function n(e){s.font=e.font,s.fillText(e.string,r/2-s.measureText(e.string).width/2,e.y),e.lineWidth&&(s.lineWidth=e.lineWidth,s.strokeStyle=e.strokeStyle,s.strokeText(e.string,r/2-s.measureText(e.string).width/2,e.y))}var d=0<arguments.length&&void 0!==arguments[0]&&arguments[0],a=new Image,e=d3.select("#map-svg"),r=e.attr("width"),o=e.attr("height"),i=u.createElement("canvas"),s=i.getContext("2d"),c=t.getComputedStyle(u.body).backgroundColor,l=t.getComputedStyle(u.body).color;i.width=r,i.height=o,e.insert("rect","g").attr({id:"background-rect",width:"100%",height:"100%"}).style({fill:c}),d3.selectAll(".legend text, text.legend").style({"font-family":function(){return t.getComputedStyle(this).fontFamily},"font-size":function(){return t.getComputedStyle(this).fontSize},fill:l}),d3.selectAll(".legend rect").style({stroke:c}),canvg(i,(new XMLSerializer).serializeToString(e[0][0])),a.onload=function(){s.save(),s.globalAlpha=.6,s.fillStyle=c;var e=SESSION.total_artists+" artists from "+countryScore+" / 210 countries",t=SESSION.name+"'s musical world map",t=(s.font="34px Patua One",s.fillRect(r/2-s.measureText(t).width/2-20,o-110,s.measureText(t).width+40,100),s.fillStyle=l,s.fillStyle=l,n({string:t,font:"34px Patua One",y:o-60}),n({string:e,font:"20px Didact Gothic",y:o-40}),s.restore(),s.drawImage(a,r-130,o-60,100,36),d3.select("#background-rect").remove(),u.getElementById("screenshot-img").src=i.toDataURL("image/png"),i.toDataURL("image/png"),u.getElementsByClassName("screenshot-overlay")[0]);t.style="",t.ariaModal=!0,d&&setTimeout(function(){screenshot.download(),screenshot.close()},0)},a.src="assets/img/explrlogo.png"},screenshot.close=function(){u.getElementsByClassName("screenshot-overlay")[0].style="display:none;",u.getElementsByClassName("screenshot-overlay")[0].ariaModal=!1},screenshot.download=function(){var e=u.getElementById("screenshot-img").src,t=u.createElement("a");t.href=e,t.download="screenshot.png",u.body.appendChild(t),t.click(),u.body.removeChild(t)}}(window,document),search||{}),SEARCH_IS_OPEN=!1,searchButton=null,filteredCountries=[],filteredArtists=[],filteredCountryArtists=[],noCountryArtists=[],filteredShortcuts=[],keyboardMode=(search.getAnnouncement=function(){var e,t=[],n=document.querySelector("input.search"),a=filteredArtists.slice(0,100).length+filteredCountryArtists.slice(0,100).length+noCountryArtists.slice(0,100).length;0<filteredShortcuts.length&&3<n.value.length&&(e=1===filteredShortcuts.length?"shortcut":"shortcuts",t.push("".concat(filteredShortcuts.length," ").concat(e))),0<filteredCountries.slice(0,5).length&&1<n.value.length&&(e=1===filteredCountries.length?"country":"countries",t.push("".concat(filteredCountries.length," ").concat(e))),a&&1<n.value.length&&(e=1===a?"artist":"artists",t.push("".concat(a," ").concat(e)));return 0<t.length?"Showing "+t.slice(0,-1).join(", ")+(1<t.length?" and ":"")+t.slice(-1)+", press down arrow to go to results":"No results found"},search.initSearch=function(){SEARCH_IS_OPEN=!0;var r=null,t=null,e=document.querySelector("#search-button"),n=(e&&(e.ariaExpanded=!0),api.getCountriesData().then(function(e){t=e}).catch(function(e){console.error(e)}),[{name:"Status",onClick:function(){}},{name:"Clear cached users",onClick:function(){clearExplrCache().then(function(){return window.location.reload()})}},{name:"Change user",onClick:function(){window.location="./"}},{name:"Change theme",onClick:function(){map.nextTheme()}},{name:"Download screenshot of map",onClick:function(){screenshot.render(!0)}},{name:"Export data",onClick:function(){utils.exportToCSV(script.getCurrentData())}},{name:"Map: Toggle between artists or scrobbles",onClick:function(){map.toggleFilter()}},{name:"Support Explr on BuyMeACoffee",onClick:function(){window.open("https://www.buymeacoffee.com/explrfm","_blank")}},{name:"View Explr on GitHub",onClick:function(){window.open("https://github.com/mold/explr","_blank")}}]),e=script.getCurrentData(),a=(o=[]).concat.apply(o,_toConsumableArray(Object.values(e))),o=(a=(a=a.reduce(function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e=e.concat(t[n]));return e},[])).sort(function(e,t){return t.playcount-e.playcount}),document.getElementById("search-container")),e=(o.classList.add("search-container"),document.createElement("div")),u=(e.classList.add("search-input-wrapper"),document.createElement("input")),s=(u.type="text",u.classList.add("search"),u.placeholder="Search for an artist or a country",u.setAttribute("aria-label","Search for an artist or a country"),u.setAttribute("aria-autocomplete","list"),u.setAttribute("aria-controls","search-results"),u.setAttribute("aria-expanded","false"),u.role="combobox",e.appendChild(u),o.appendChild(e),setTimeout(function(){u.focus()},50),document.createElement("div"));s.classList.add("search-results"),s.id="search-results",s.setAttribute("role","listbox"),s.setAttribute("aria-label","Search results"),o.appendChild(s),u.addEventListener("input",function(){s.innerHTML="",u.setAttribute("aria-expanded","true");var r,o,i,c,l,d,e=n.filter(function(e){return"Status"!==e.name});0<(filteredShortcuts=e.filter(function(e){return"shortcuts"===u.value.toLowerCase()||e.name.toLowerCase().includes(u.value.toLowerCase())})).length&&3<u.value.length&&(r=document.createElement("ul"),(o=document.createElement("li")).textContent="Explr.fm shortcuts",o.id="shortcuts-heading",o.role="presentation",o.classList.add("search-result-heading"),r.appendChild(o),r.setAttribute("role","group"),r.classList.add("search-result-group"),r.ariaLabelledby="shortcuts-heading",s.appendChild(r),filteredShortcuts.forEach(function(e){var t,n,a;3<u.value.length&&("Status"===e.name&&(o.textContent="Explr.fm status"),(t=document.createElement("div")).classList.add("result-wrapper"),t.role="option",t.id="shortcut-".concat(e.name.replace(/\s+/g,"-").toLowerCase()),t.addEventListener("click",function(){e.onClick()}),(n=document.createElement("span")).classList.add("shortcut-name"),a=new RegExp(u.value,"gi"),a=("Status"===e.name?script.getLoadingStatus():e.name).replace(a,function(e){return'<span class="highlight">'.concat(e,"</span>")}),n.innerHTML=a,t.appendChild(n),r.appendChild(t))})),0<(filteredCountries=t.filter(function(e){return e.names.some(function(e){return e.toLowerCase().includes(u.value.toLowerCase())})})).length&&1<u.value.length&&(i=document.createElement("ul"),(e=document.createElement("li")).textContent="Countries",e.classList.add("search-result-heading"),e.id="countries-heading",e.role="presentation",i.appendChild(e),i.setAttribute("role","group"),i.classList.add("search-result-group"),i.setAttribute("aria-labelledby","countries-heading"),s.appendChild(i),filteredCountries.slice(0,5).forEach(function(t){var e,n,a,r;1<u.value.length&&((e=document.createElement("div")).classList.add("result-wrapper","country"),e.role="option",e.id="country-".concat(t.name.replace(/\s+/g,"-").toLowerCase()),e.addEventListener("click",function(){search.stopSearch();var e=document.querySelector(".country#c".concat(t.id));e&&(e.dispatchEvent(new Event("click")),setTimeout(function(){document.querySelector("#cnameCont h1").setAttribute("tabindex","-1"),document.querySelector("#cnameCont h1").focus()},250))}),(n=document.createElement("span")).classList.add("country-name"),(a=document.createElement("span")).classList.add("country-artist-count"),a.textContent="".concat(utils.getNumberOfArtistsForCountry(t.id)," artists"),r=new RegExp(u.value,"gi"),r=t.name.replace(r,function(e){return'<span class="highlight">'.concat(e,"</span>")}),n.innerHTML=r,e.appendChild(n),e.appendChild(a),i.appendChild(e))})),0<(filteredArtists=a.filter(function(e){return e.artist.toLowerCase().includes(u.value.toLowerCase())})).length&&1<u.value.length&&((c=document.createElement("ul")).classList.add("search-result-group"),(e=document.createElement("li")).textContent="Artists",e.role="presentation",e.classList.add("search-result-heading"),e.id="artists-heading",c.appendChild(e),c.setAttribute("role","group"),c.setAttribute("aria-labelledby","artists-heading"),s.appendChild(c),filteredArtists.slice(0,100).forEach(function(t){var e,n,a,r,o,i,s;1<u.value.length&&((e=document.createElement("div")).classList.add("result-wrapper"),e.role="option",e.id="artist-".concat(t.artist.replace(/\s+/g,"-").toLowerCase()),e.addEventListener("click",function(){search.stopSearch(),utils.getCountryNameFromId(t.id)||window.open(t.url,"_blank");var e=document.querySelector(".country#c".concat(t.id));e&&(e.dispatchEvent(new Event("click")),setTimeout(function(){map.searchArtist(t.artist)},250))}),(n=document.createElement("span")).classList.add("artist-wrapper"),(a=document.createElement("span")).classList.add("country-wrapper"),(r=document.createElement("span")).classList.add("visually-hidden"),r.textContent=", from ",(o=document.createElement("span")).classList.add("playcount"),o.textContent="".concat(t.playcount," scrobbles"),(s=document.createElement("span")).classList.add("artist-name"),i=new RegExp(u.value,"gi"),i=t.artist.replace(i,function(e){return'<span class="highlight">'.concat(e,"</span>")}),s.innerHTML=i,n.appendChild(s),n.appendChild(o),(i=document.createElement("span")).classList.add("country-name"),i.textContent=utils.getCountryNameFromId(t.id)?utils.getCountryNameFromId(t.id):"Unknown country :-(",a.appendChild(i),a.prepend(r),utils.getCountryNameFromId(t.id)||((s=document.createElement("span")).classList.add("add-tags"),s.textContent="Go add some tags on Last.fm!",a.appendChild(s)),e.appendChild(n),e.appendChild(a),c.appendChild(e),c.classList.add("artists-wrapper"))})),0<(filteredCountryArtists=a.filter(function(e){return 1===filteredCountries.length&&filteredCountries[0].id===e.id})).length&&1<u.value.length&&((l=document.createElement("ul")).classList.add("search-result-group"),(e=document.createElement("li")).textContent="Artists from "+filteredCountries[0].name,e.role="presentation",e.classList.add("search-result-heading"),e.id="artists-country-heading",l.appendChild(e),l.setAttribute("role","group"),l.setAttribute("aria-labelledby","artists-country-heading"),s.appendChild(l),filteredCountryArtists.slice(0,100).forEach(function(t){var e,n,a,r,o,i,s;1<u.value.length&&((e=document.createElement("div")).classList.add("result-wrapper"),e.role="option",e.id="".concat(filteredCountries[0].name,"-artist-").concat(t.artist.replace(/\s+/g,"-").toLowerCase()),e.addEventListener("click",function(){search.stopSearch();var e=document.querySelector(".country#c".concat(t.id));e&&(e.dispatchEvent(new Event("click")),setTimeout(function(){map.searchArtist(t.artist)},250))}),(n=document.createElement("span")).classList.add("artist-wrapper"),(a=document.createElement("span")).classList.add("country-wrapper"),(r=document.createElement("span")).classList.add("visually-hidden"),r.textContent=", from ",(o=document.createElement("span")).classList.add("playcount"),o.textContent="".concat(t.playcount," scrobbles"),(i=document.createElement("span")).classList.add("artist-name"),s=new RegExp(u.value,"gi"),s=t.artist.replace(s,function(e){return'<span class="highlight">'.concat(e,"</span>")}),i.innerHTML=s,n.appendChild(i),n.appendChild(o),a.textContent=utils.getCountryNameFromId(t.id),a.prepend(r),e.appendChild(n),e.appendChild(a),l.appendChild(e),l.classList.add("artists-wrapper"))})),0<(noCountryArtists=a.filter(function(e){return"unknown"===u.value.toLowerCase()&&!e.id})).length&&1<u.value.length&&((d=document.createElement("ul")).classList.add("search-result-group"),(e=document.createElement("li")).textContent="Artists without a country (first 100)",e.role="presentation",e.classList.add("search-result-heading"),e.id="unknown-artists-heading",d.appendChild(e),d.setAttribute("role","group"),d.setAttribute("aria-labelledby","unknown-artists-heading"),s.appendChild(d),noCountryArtists.slice(0,100).forEach(function(t){var e,n,a,r,o,i,s;1<u.value.length&&((e=document.createElement("div")).classList.add("result-wrapper"),e.role="option",e.id="artist-".concat(t.artist.replace(/\s+/g,"-").toLowerCase()),e.addEventListener("click",function(){search.stopSearch(),utils.getCountryNameFromId(t.id)||window.open(t.url,"_blank");var e=document.querySelector(".country#c".concat(t.id));e&&(e.dispatchEvent(new Event("click")),setTimeout(function(){map.searchArtist(t.artist)},250))}),(n=document.createElement("span")).classList.add("artist-wrapper"),(a=document.createElement("span")).classList.add("country-wrapper"),(r=document.createElement("span")).classList.add("visually-hidden"),r.textContent=", from ",(o=document.createElement("span")).classList.add("playcount"),o.textContent="".concat(t.playcount," scrobbles"),(s=document.createElement("span")).classList.add("artist-name"),i=new RegExp(u.value,"gi"),i=t.artist.replace(i,function(e){return'<span class="highlight">'.concat(e,"</span>")}),s.innerHTML=i,n.appendChild(s),n.appendChild(o),(i=document.createElement("span")).classList.add("country-name"),i.textContent=utils.getCountryNameFromId(t.id)?utils.getCountryNameFromId(t.id):"Unknown country :-(",a.appendChild(i),a.prepend(r),utils.getCountryNameFromId(t.id)||((s=document.createElement("span")).classList.add("add-tags"),s.textContent="Go add some tags on Last.fm!",a.appendChild(s)),e.appendChild(n),e.appendChild(a),d.appendChild(e),d.classList.add("artists-wrapper"))})),clearTimeout(typingTimeout),typingTimeout=setTimeout(function(){announcer.announce(search.getAnnouncement(),"polite")},750)}),window.addEventListener("keydown",function(e){var t,n,a=document.querySelector(".search");r&&(8===e.keyCode||65<=e.keyCode&&e.keyCode<=90)&&(r.removeAttribute("aria-selected"),r.classList.remove("focused"),a.removeAttribute("aria-activedescendant"),r=null,s.scrollTop=0),40===e.keyCode&&SEARCH_IS_OPEN&&(e.preventDefault(),r?(r.removeAttribute("aria-selected"),r.classList.remove("focused"),a.removeAttribute("aria-activedescendant"),(t=r.nextElementSibling)||(n=r.parentElement.nextElementSibling)&&(t=n.querySelector(".result-wrapper")),(r=t)&&(r.classList.add("focused"),r.setAttribute("aria-selected","true"),a.setAttribute("aria-activedescendant",r.id),r.scrollIntoView({behavior:"smooth",block:"nearest"}))):((r=document.querySelector(".result-wrapper")).classList.add("focused"),r.setAttribute("aria-selected","true"),a.setAttribute("aria-activedescendant",r.id),r.scrollIntoView({behavior:"smooth",block:"nearest"}))),38===e.keyCode&&SEARCH_IS_OPEN&&(e.preventDefault(),r&&(r.classList.remove("focused"),r.removeAttribute("aria-selected"),a.removeAttribute("aria-activedescendant"),(n=r.previousElementSibling.classList.contains("search-result-heading")?null:r.previousElementSibling)||((t=r.parentElement.previousElementSibling)?n=(t=t.querySelectorAll(".result-wrapper"))[t.length-1]:(t=(t=document.querySelectorAll(".search-result-group"))[t.length-1])&&(n=(t=t.querySelectorAll(".result-wrapper"))[t.length-1])),(r=n)&&(r.classList.add("focused"),r.setAttribute("aria-selected","true"),a.setAttribute("aria-activedescendant",r.id),r.scrollIntoView({behavior:"smooth",block:"nearest"})))),13===e.keyCode&&SEARCH_IS_OPEN&&(e.preventDefault(),(t=a.getAttribute("aria-activedescendant"))?(n=document.getElementById(t))&&n.dispatchEvent(new Event("click")):(console.log("no active descendant"),(a=document.querySelector(".result-wrapper"))&&a.dispatchEvent(new Event("click")))),27===e.keyCode&&SEARCH_IS_OPEN&&search.stopSearch()}),window.addEventListener("click",function(e){SEARCH_IS_OPEN&&!e.target.closest(".search-container")&&search.stopSearch()})},search.stopSearch=function(){var e=document.querySelector("#search-button"),t=document.querySelector(".search"),t=(void 0!==t&&(t.removeAttribute("aria-activedescendant"),t.setAttribute("aria-expanded","false")),document.querySelector(".search-container"));t&&(t.innerHTML=""),e&&(e.focus({preventScroll:!0}),e.ariaExpanded=!1),SEARCH_IS_OPEN=!1},search.getSearchStatus=function(){return SEARCH_IS_OPEN},search.setSearchStatus=function(e){SEARCH_IS_OPEN=e},window.initSearch=search.initSearch,keyboardMode||{}),MIN_ZOOM_LEVEL_FOR_KEYBOARD_MODE=7,MAX_COUNTRY_SUGGESTIONS=20,KEYBOARD_MODE_ACTIVE=!1,ALPHABET="ABCDEFGIJKMNOPQRSTUVWXYZ".split(""),visibleCountries=[],keyBuffer="",keyBufferTimer=null,keyboardModeActive=!1,isKeyboardModeEnabled=!1,currentFocus=null,EXCLUDED_COUNTRY_IDS=[831,832,833,136,796],handleLetterKeyPress=function(e){e.key.match(/[a-zA-Z]/)&&"INPUT"!==e.target.tagName&&(e.ctrlKey||e.altKey||e.shiftKey||e.metaKey||(e=e.key.toUpperCase(),0<=(e=ALPHABET.indexOf(e))&&e<visibleCountries.length&&((e=visibleCountries[e])&&(e.dispatchEvent(new Event("click")),setTimeout(function(){document.querySelector("#cnameCont h1").setAttribute("tabindex","-1"),document.querySelector("#cnameCont h1").focus()},250),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Opened country",eventLabel:"test"})))))};function getCurrentlyVisibleCountries(){var r=window.location.href.split("username=")[1],o=script.getCurrentData(),i=[];return o&&r?visibleCountries.forEach(function(e){var t,n,a=parseInt(e.id.slice(1));EXCLUDED_COUNTRY_IDS.includes(a)||(e=ALPHABET[visibleCountries.indexOf(e)],t=o[a]&&o[a][r]?o[a][r].length:0,(n=utils.getCountryNameFromId(a))&&"undefined"!==n&&i.push({name:n,number:e,artistCount:t,id:a}))}):console.warn("Data or username not available"),i}function isInViewport(e){var t=parseInt(e.id.slice(1));if(EXCLUDED_COUNTRY_IDS.includes(t))return!1;if(map.COUNTRY_BBOX_OVERRIDES&&map.COUNTRY_BBOX_OVERRIDES[t])return t=map.COUNTRY_BBOX_OVERRIDES[t],(Array.isArray(t[0])?t:[t]).some(function(e){return isBBoxInViewport(e)});var t=e.getBoundingClientRect(),e=(window.innerWidth-400)/2,n=(window.innerHeight-400)/2;return t.top<=400+n&&t.bottom>=n&&t.left<=400+e&&t.right>=e}function isBBoxInViewport(e){var e=_slicedToArray(e,4),t=e[0],n=e[1],a=e[2],e=e[3],e=[[t,e],[a,e],[a,n],[t,n]].map(function(e){e=map.projection(e);return{x:e[0],y:e[1]}}),a=Math.min.apply(Math,_toConsumableArray(e.map(function(e){return e.x}))),t=Math.max.apply(Math,_toConsumableArray(e.map(function(e){return e.x}))),n=Math.min.apply(Math,_toConsumableArray(e.map(function(e){return e.y}))),e=Math.max.apply(Math,_toConsumableArray(e.map(function(e){return e.y}))),r=(d3.select("#map-svg").call(map.zoom),map.zoom.scale()),o=map.zoom.translate(),a=o[0]+a*r,t=o[0]+t*r,n=o[1]+n*r,o=o[1]+e*r,e=(window.innerWidth-400)/2,r=(window.innerHeight-400)/2;return!(t<e||400+e<a||o<r||400+r<n)}function displayKeyboardModeMessage(){var e=document.getElementById("keyboard-mode-message"),t=(e.classList.remove("hidden"),document.createElement("div"));t.innerHTML="<h2>Keyboard mode active! <span class='fa fa-keyboard'></span> </h2><p>Type a <kbd>letter</kbd> to select a country.<p><p>Move around with <kbd>&#8592;</kbd><kbd>&#8594;</kbd><kbd>&#8593;</kbd><kbd>&#8595;</kbd> keys.</p><p>Exit by zooming out with <kbd>-</kbd> key. </p>",e.appendChild(t)}function hideKeyboardModeMessage(){var e=document.getElementById("keyboard-mode-message");e.classList.add("hidden"),e.innerHTML=""}function getPathCenter(e){var t=parseFloat(e.getAttribute("data-center-y"));return{x:-parseFloat(e.getAttribute("data-center-x")),y:-t}}var hasAnnounced=!1;function getVisibleCountries(){var e=d3.selectAll(".country"),t=[];return e.each(function(){t.push(this)}),t.filter(function(e){var t=parseInt(e.id.slice(1));if(EXCLUDED_COUNTRY_IDS.includes(t))return!1;t=utils.getCountryNameFromId(t);return!(!t||"undefined"===t)&&isInViewport(e)})}function updateVisibleCountries(e){keyboardMode.cleanup(),visibleCountries=getVisibleCountries(),e&&e.scale()>=MIN_ZOOM_LEVEL_FOR_KEYBOARD_MODE&&(KEYBOARD_MODE_ACTIVE=!0,displayKeyboardModeMessage(),hasAnnounced||(announcer.announce("Keyboard mode active! Press L to hear the list of countries."),hasAnnounced=!0),document.getElementById("controls").classList.add("hidden"),document.getElementById("legend").classList.add("hidden"),document.getElementById("filter-text").classList.add("hidden"),document.getElementById("filter").classList.add("hidden"),document.querySelector(".no-countries").classList.add("hidden"),document.getElementById("friends").classList.add("hidden"),visibleCountries.forEach(function(e){window.addEventListener("keydown",handleLetterKeyPress);var t=getPathCenter(e),n=ALPHABET[visibleCountries.indexOf(e)];d3.select(e.parentElement).append("rect").attr("class","a11y-number-bg").attr("x",t.x-1.5).attr("y",t.y-1.5).attr("width",3).attr("height",3).attr("rx",.5).attr("ry",.5),d3.select(e.parentElement).append("text").attr("class","a11y-number").attr("data-country-id",e.id).attr("text-anchor","middle").attr("alignment-baseline","middle").attr("x",t.x).attr("y",t.y+.2).text(n),d3.select(e.parentElement).append("text").attr("class","a11y-country-name").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("font-size","0.1rem").attr("x",t.x).attr("y",t.y+4).text(utils.getCountryNameFromId(parseInt(e.id.slice(1))))}))}keyboardMode.init=function(s,c,l,d,u){window.addEventListener("keydown",function(e){var t=window.location.href.split("username=")[1];if(!search.getSearchStatus()&&t){var n=s.translate(),a=s.scale(),r=[l/2,d/2];switch(e.key){case"Escape":if(null!==map.centered)return map.dismissCenteredCountry(),void keyboardMode.cleanup();var o=1;n[0]=r[0]+(n[0]-r[0])*o/a,n[1]=r[1]+(n[1]-r[1])*o/a,a=o,e.preventDefault(),c(n,a,!1,!0),keyboardMode.cleanup(),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Escape key",eventLabel:"test"});break;case"ArrowUp":n[1]+=100,e.preventDefault(),c(n,a,!1,!0),getVisibleCountries(),announcer.announce("Panning north","assertive",100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"ArrowUp key",eventLabel:"test"});break;case"ArrowDown":n[1]-=100,e.preventDefault(),c(n,a,!1,!0),getVisibleCountries(),announcer.announce("Panning south","assertive",100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"ArrowDown key",eventLabel:"test"});break;case"ArrowLeft":n[0]+=100,e.preventDefault(),c(n,a,!1,!0),getVisibleCountries(),announcer.announce("Panning west","assertive",100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"ArrowLeft key",eventLabel:"test"});break;case"ArrowRight":n[0]-=100,e.preventDefault(),c(n,a,!1,!0),getVisibleCountries(),announcer.announce("Panning east","assertive",100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"ArrowRight key",eventLabel:"test"});break;case"+":case"-":o="+"===e.key?1.25*a:a/1.25;n[0]=r[0]+(n[0]-r[0])*(o=u<o?u:o)/a,n[1]=r[1]+(n[1]-r[1])*o/a,a=o,e.preventDefault(),c(n,a,!1,!0),getVisibleCountries(),announcer.announce("Zoom ".concat("+"===e.key?"in":"out"," level ").concat(parseInt(o)),"assertive",100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Zoom in/out",eventLabel:"test"});break;case"h":announcer.announce(document.getElementById("a11y-info-text").textContent,"polite"),console.log(document.getElementById("a11y-info-text").textContent),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Help",eventLabel:"test"});break;case"l":if(!KEYBOARD_MODE_ACTIVE)return announcer.announce("Keyboard mode is not active right now. Zoom in to at least level 7 to activate.","assertive",100),void ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"List countries (premature)",eventLabel:"test"});var i="List of countries: ";getCurrentlyVisibleCountries().forEach(function(e){i+="".concat(e.number,": ").concat(e.name," (").concat(e.artistCount," artists), ")}),announcer.announce(i,"assertive",100),console.log(i),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"List countries",eventLabel:"test"});break;default:return}null!==map.centered&&map.dismissCenteredCountry()}})},keyboardMode.cleanup=function(){hideKeyboardModeMessage(),KEYBOARD_MODE_ACTIVE=!1,d3.selectAll(".a11y-number").remove(),d3.selectAll(".a11y-number-bg").remove(),d3.selectAll(".a11y-country-name").remove(),document.getElementById("controls").classList.remove("hidden"),document.getElementById("friends").classList.remove("hidden"),document.getElementById("legend").classList.remove("hidden"),document.getElementById("filter-text").classList.remove("hidden"),document.getElementById("filter").classList.remove("hidden"),document.querySelector(".no-countries").classList.remove("hidden"),window.removeEventListener("keydown",handleLetterKeyPress)},keyboardMode.isActive=KEYBOARD_MODE_ACTIVE,keyboardMode.getStatus=function(){return KEYBOARD_MODE_ACTIVE},keyboardMode.updateVisibleCountries=function(e){updateVisibleCountries(e)};var noCountries=noCountries||{},listOfArtistsWithNoCountry=[],saveToStorage=function(e,t,n){localforage.setItem(e,t,n||function(){})};function sortArtists(e,t){return"scrobbles"===t?e.sort(function(e,t){return t.playcount-e.playcount}):"name"===t?e.sort(function(e,t){return e.artist.localeCompare(t.artist)}):void 0}var announcementIntervalId,STORED_ARTISTS,CACHED_NO_COUNTRIES,addArtistsWithNoCountry=function(e){function o(){var e,t=this.id,n=this.checked,a=JSON.parse(localStorage.getItem("noCountryArtistsProgress"))||{};a[t]={artistName:t,checked:n},localStorage.setItem("noCountryArtistsProgress",JSON.stringify(a)),n&&null!==(e=document.querySelector("#hide-checked"))&&void 0!==e&&e.checked&&(this.parentNode.style.display="none",(t=this.parentNode.nextElementSibling.querySelector("input"))&&t.focus()),document.querySelector("label[for='hide-checked']").innerHTML="Hide checked artists (".concat(document.querySelectorAll("dialog[open] ul li input[type='checkbox']:checked").length,")"),ga("send",{hitType:"event",eventCategory:"No countries",eventAction:"Check artist as done",eventLabel:"test"})}function r(){var a=JSON.parse(localStorage.getItem("noCountryArtistsProgress"))||{},e=sortArtists(listOfArtistsWithNoCountry,noCountryArtistSortMethod),r=d3.select(".no-countries__content ul");r.html(""),e.forEach(function(e){var t=a[e.artist]||{artistName:e.artist,checked:!1},n=r.append("li");n.append("input").attr("type","checkbox").property("checked",t.checked).attr("id",e.artist).on("change",o),n.append("label").attr("for",e.artist).html('<a href="'+e.url+'" target="blank" class="no-countries__link">'+e.artist+"</a><span>"+e.playcount+" scrobbles</span>"),null!==(e=document.querySelector("#hide-checked"))&&void 0!==e&&e.checked&&t.checked&&n.style("display","none")}),d3.select(".no-countries__info").html(listOfArtistsWithNoCountry.length+" artists without a country:")}listOfArtistsWithNoCountry=listOfArtistsWithNoCountry.concat(e),saveToStorage("no_countries",listOfArtistsWithNoCountry),d3.select("#hide-checked").node()||d3.select("label[for='hide-checked']").node()||(d3.select("dialog fieldset").append("input").attr("type","checkbox").attr("id","hide-checked").on("change",r),d3.select("dialog fieldset").append("label").attr("for","hide-checked").text("Hide checked artists"));var i=document.getElementsByName("sort");function t(){var e,t,n=_createForOfIteratorHelper(i);try{for(n.s();!(t=n.n()).done;){var a=t.value;if(a.checked){e=a.value,noCountryArtistSortMethod=e,r();break}}}catch(e){n.e(e)}finally{n.f()}ga("send",{hitType:"event",eventCategory:"No countries",eventAction:"Sort artists",eventLabel:"test"})}var n,a=_createForOfIteratorHelper(i);try{for(a.s();!(n=a.n()).done;)n.value.addEventListener("change",t)}catch(e){a.e(e)}finally{a.f()}r(),document.querySelector(".no-countries__title").addEventListener("click",function(){document.querySelector(".no-countries__content").showModal(),document.querySelector("#no-countries__heading").focus(),document.querySelector("label[for='hide-checked']").innerHTML="Hide checked artists (".concat(document.querySelectorAll("dialog[open] ul li input[type='checkbox']:checked").length,")"),document.addEventListener("keydown",function(e){27==e.keyCode&&(document.querySelector(".no-countries__content").close(),document.querySelector(".no-countries__title").focus())}),ga("send",{hitType:"event",eventCategory:"No countries",eventAction:"Open dialog",eventLabel:"test"})}),document.querySelector(".no-countries__content .close").addEventListener("click",function(){document.querySelector(".no-countries__content").close(),document.querySelector(".no-countries__title").focus()});var s=document.querySelector(".no-countries__content");s.addEventListener("click",function(e){e.target===s&&s.close()}),listOfArtistsWithNoCountry.length&&setTimeout(function(){document.querySelector(".no-countries").classList.remove("hidden")},850)},script=(noCountries.addArtistsWithNoCountry=addArtistsWithNoCountry,script||{}),loadingReady=!1,loadingStatus=loadingReady?"Ready to Explr!":"Loading...",noCountryArtistSortMethod="scrobbles",STORED_ARTISTS_PROMISE=localforage.getItem("artists").then(function(e){return STORED_ARTISTS=e||{}}),CACHED_NO_COUNTRIES_PROMISE=localforage.getItem("no_countries").then(function(e){return CACHED_NO_COUNTRIES=e||{}}),USER_TAGS=[],CACHED_USERS=JSON.parse(window.localStorage.cached_users||"{}"),SESSION={};function clearExplrCache(){var e=window.localStorage.getItem("theme");return window.localStorage.clear(),window.localStorage.setItem("theme",e),announcer.announce("Cleared artist cache, reloading page..."),localforage.clear()}var legend,countryCountObj={},map=(!function(){function a(){loadingReady=!1,api.lastfm.send("library.getartists",[["user",i],["limit",50],["page",o]],function(e,t){if(""===t)return console.error('Got empty string ("") as response, skipping page.'),o++,void a();if(e||t.error)return console.error("Error in getAllArtists, page "+o,e,t),void(s++<5?a():confirm("Last.fm took too long to respond.\n\nPress OK to refresh the page and try again, or Cancel to use the page as it is.")&&clearExplrCache().then(function(){l("artists",STORED_ARTISTS,function(){window.location.reload()})}));if(s=0,1===o&&(SESSION.total_artists=+t.artists["@attr"].total,r=+t.artists["@attr"].totalPages,0===SESSION.total_artists))return d3.select(".bubblingG").remove(),d3.select("#loading-text").html("You haven't listened to any<br> artists yet. Start scrobbling with <br>                                                        <a href='http://evolver.fm/2012/05/08/how-to-scrobble-to-last-fm-from-itunes-spotify-and-more/'>your favorite music player!</a>"),void d3.select(".loader").style("pointer-events","all");o++;var n=[];t.artists.artist.forEach(function(e){var t=STORED_ARTISTS[e.name]||{};t.playcount=+e.playcount,t.url=e.url,STORED_ARTISTS[e.name]=t,n.push(e.name)}),l("artists",STORED_ARTISTS),api.getCountries(n,function(e){var t=d3.nest().key(function(e){return e.id}).rollup(function(e){return e}).map(e);d3.keys(t).forEach(function(e){countryCountObj[e]=countryCountObj[e]||{},countryCountObj[e][i]=countryCountObj[e][i]||[];var n=countryCountObj[e][i];(n=n.concat(t[e])).forEach(function(e,t){n[t].url=STORED_ARTISTS[e.artist].url,n[t].playcount=STORED_ARTISTS[e.artist].playcount}),countryCountObj[e][i]=n}),noCountries.addArtistsWithNoCountry(e.filter(function(e){return!e.id})),map.addArtists(t),(r<o?c:a)()})})}function n(e,t){(e||t.error)&&t&&6===t.error&&(alert("User not found"),window.location.assign(window.location.origin+window.location.pathname));var i=0,s={},c=t.topartists.artist;c.forEach(function(e,t){setTimeout(function(){api.lastfm.send("artist.gettoptags",[["artist",e.name]],function(e,t){var a,n=t.toptags&&t.toptags.tag;if(n)for(var r=Math.min(n.length,10),o=0;o<r;o++)s[n[o].name]?s[n[o].name]++:s[n[o].name]=1;++i==c.length-1&&(USER_TAGS=[],a=["american","swedish","british","female vocalists","male vocalists","german","seen live","english","singer-songwriter","spanish","french"],d3.keys(s).forEach(function(e){for(var t=!1,n=0;n<a.length;n++)e===a[n]&&(t=!0);t||USER_TAGS.push({tag:e,count:s[e]})}),USER_TAGS.sort(function(e,t){return t.count<e.count?-1:t.count>e.count?1:0}),console.info("Done getting tags, saved to localStorage.user_tags"),window.localStorage.user_tags=JSON.stringify(USER_TAGS))})},3e3*Math.random())})}var i,r,o=1,s=0,e=["Malawi","Malaysia","Peru","Sierra Leone","Trinidad & Tobago","Greece","Laos","Iran","Haiti","Nicaragua","Mongolia","Slovakia"],c=function(){loadingReady=!0,clearInterval(announcementIntervalId),announcer.announce("All artists have been loaded!");var e=document.querySelector("#map-container svg"),t=e.getAttribute("aria-labelledby"),n=(e.setAttribute("aria-labelledby","".concat(t," progress-text sr-instructions")),d3.select(".loader"));n.transition().duration(2e3).style("opacity",0).each("end",function(){n.remove()}),d3.select("#progress-text").transition().delay(5e3).duration(1500).style("opacity",0),(CACHED_USERS={})[i]=(new Date).getTime(),window.localStorage.cached_users=JSON.stringify(CACHED_USERS),window.localStorage.countryCountObj=JSON.stringify(countryCountObj)},t=window.location.href.split("username=")[1],l=(t?(document.addEventListener("DOMContentLoaded",function(e){document.getElementById("search-button").addEventListener("click",function(){setTimeout(function(){search.initSearch()},0)})}),window.addEventListener("keydown",function(e){if(!e.ctrlKey&&!e.metaKey||70!==e.keyCode||e.shiftKey||keyboardMode.getStatus()||(console.log(keyboardMode.getStatus()),e.preventDefault(),search.initSearch()),!search.getSearchStatus()&&!keyboardMode.getStatus())switch(e.keyCode){case 83:screenshot.render(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Take screenshot",eventLabel:"test"});break;case 84:nextTheme(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Cycle theme",eventLabel:"test"})}}),15<t.length&&(t=t.substr(0,15)),i=t,SESSION.name=t,Promise.all([CACHED_NO_COUNTRIES_PROMISE,STORED_ARTISTS_PROMISE]).then(function(){return ga("send","event","splash screen","Go!","test"),document.getElementById("map-label").innerHTML="".concat(i,"'s world map"),(t=d3.select("#welcome-container")).transition().duration(2e3).style("opacity",0).each("end",function(){t.remove()}),d3.select(".loader").transition().duration(2e3).style("opacity",1),d3.select("#loading-text").html("Getting library..."),setTimeout(function(){var e;announcer.announce(null===(e=document.getElementById("loading-text"))||void 0===e?void 0:e.innerText)},6e3),setTimeout(function(){var e;"Getting library..."===(null===(e=d3.select("#loading-text"))||void 0===e?void 0:e.html())&&(d3.select("#loading-text").html("Last.fm is taking<br>a long time to<br>respond..."),setTimeout(function(){"Last.fm is taking<br>a long time to<br>respond..."===d3.select("#loading-text").html()&&d3.select("#loading-text").html("Maybe <a href='http://last.fm' target='_blank'>last.fm</a> has<br>gone offline...").style("pointer-events","all")},8e3))},8e3),document.getElementById("a11y-map-info").classList.remove("hidden"),d3.selectAll(".on-map-view").style({visibility:"visible"}),api.lastfm.send("user.gettopartists",[["user",i],["period","12months"],["limit","50"]],n),api.getFriends(function(e,t){try{var n=t.friends.user,a=0,r=d3.select("#friend-name"),o=function(){r.html(""),r.append("a").attr({href:window.location.origin+window.location.pathname+"?username="+n[a].name,target:"_self"}).html(n[a].name)};d3.selectAll(".arrow").on("click",function(){a=d3.select(this).classed("left")?0===a?n.length-1:a-1:(a+1)%n.length,o()}),o(),d3.select("#friends #msg").html("Check out "+i+"'s friends"),d3.select("#friends").transition().duration(1e3).style("opacity",1)}catch(e){console.error("getFriends()",e),d3.select("#friends").html("&nbsp;Couldn't find any<br>friends on last.fm :(&nbsp;"),d3.select("#friends").transition().duration(1e3).style("opacity",1)}}),void(CACHED_USERS[i]?(console.info("No new artists on last.fm!"),countryCountObj=JSON.parse(window.localStorage.countryCountObj),localforage.getItem("no_countries",function(e,t){noCountries.addArtistsWithNoCountry(t||[])}),api.lastfm.send("library.getartists",[["user",i],["limit",1],["page",1]],function(e,t){SESSION.total_artists=+t.artists["@attr"].total}),setTimeout(function(){map.addArtists(Object.keys(countryCountObj).reduce(function(e,t){return _objectSpread(_objectSpread({},e),{},_defineProperty({},t,countryCountObj[t][SESSION.name]))},{})),c()},1e3)):(e=window.localStorage.theme,window.localStorage.clear(),e&&(window.localStorage.theme=e),a()));var e,t})):(d3.select("#welcome-container").style("visibility","visible"),d3.select("#randomCountry").html(e[Math.floor(Math.random()*e.length)]+"?")),function(e,t,n){localforage.setItem(e,t,n||function(){})})}(),script.getCurrentData=function(){return loadingReady?JSON.parse(window.localStorage.getItem("countryCountObj")):countryCountObj},script.getLoadingStatus=function(){return loadingStatus},script.setLoadingStatus=function(e){loadingStatus=e},{}),colorArray=["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],countryScore=0,currentPage=1,itemsPerPage=5,artists=[],currentZoom=1,MAX_ZOOM=25,prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,COUNTRY_BBOX_OVERRIDES={840:[[-125,24,-66,50],[-180,51,-130,72],[-160,18,-154,23]],643:[[27.5,41,180,82],[-180,60,-169,71]],152:[[-75.6,-55.9,-66,-17.5],[-109.5,-27.2,-109.2,-27],[-80.8,-33.8,-80,-33.3]],218:[[-81.5,-5,-75,1.5],[-92,-1.4,-89.2,1.7]],724:[[-9.3,36,3.4,43.8],[-18.2,27.6,-13.3,29.5],[1.2,38.6,4.4,40.1]],620:[[-9.5,36.8,-6.2,42.2],[-31.3,32.6,-16.2,39.7]],250:[[-5.1,41.3,9.6,51.1],[-54.6,2.1,-51.6,5.8],[55.2,-21.4,55.8,-20.8],[-61.2,14.4,-60.8,14.9],[-61.8,15.8,-61,16.5],[8.5,41.3,9.6,43]],528:[[3.3,50.7,7.2,53.6],[-69.2,12,-68.2,12.4],[-69,11.9,-68.2,12.4],[-63.2,17.9,-62.9,18.1]],554:[[166,-47.5,179,-34],[172.5,-43.9,173.9,-40.5]],242:[[177,-21,180,-16],[-180,-21,-178,-16]],296:[[172,-3,177,5],[-175,-11.5,-170,-5],[-160,-5,-150,12]]};map.COUNTRY_BBOX_OVERRIDES=COUNTRY_BBOX_OVERRIDES,function(m,f){d3.select(m).on("resize",function(){m.clearTimeout(I),I=m.setTimeout(function(){B(!0),j([0,0],1)},200)});var c,l,r,u,g,o,y,v,p,b,C,i="artists",s=d3.behavior.zoom().scaleExtent([1,MAX_ZOOM]).on("zoom",j),h={},S=!1,d=[0,1,2,3,4,5,6],a=1,E=0,e=m.matchMedia("(prefers-color-scheme: dark)").matches?"blue_black":"pink_white",n=m.localStorage.theme||e;function t(){c=m.innerHeight-5,l=f.getElementById("map-container").offsetWidth}function A(e){if(h[e.id]){for(var t=0,n=0;n<h[e.id].length;n++)t+=h[e.id][n].playcount;return t}return 0}function w(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}function _(){var e=-1;switch(i){case"artists":for(var e=a,t=0;t<5;t++)d[t]=Math.pow(Math.E,Math.log(e)/6*(t+1));d=[0,1,d[0],d[1],d[2],d[3],d[4]];break;case"scrobbles":e=E;for(var n=0;n<7;n++)d[n]=Math.pow(Math.E,Math.log(e)/7*(n+1));d=[0,1,d[1],d[2],d[3],d[4],d[5]]}b=d3.scale.threshold().domain(d).range(colorArray)}function k(){for(var e=0,t=d.length;e<t;)d[e]=Math.ceil(d[e]),e++;var a=[w(d[0])+"",d[1]+"-"+(d[2]-1),d[2]+"-"+(d[3]-1),d[3]+"-"+(d[4]-1),d[4]+"-"+w(d[5]-1),w(d[5])+"-"+w(d[6]-1),"> "+w(d[6])],e=(o.select("g#legend").selectAll("g.legend").remove(),legend=o.select("g#legend").selectAll("g.legend").data(d),.03*l),n=.03*c,r=o.select("#filter-text").attr("x",e).attr("y",c-n-20*d.length-30).text("Number of "),r=(o.select("#filter").attr("x",e+r[0][0].getComputedTextLength()+5).attr("y",c-n-20*d.length-30).text(i).on("click",function(){i="artists"===i?"scrobbles":"artists",B()}),d3.select(".no-countries").style("bottom",n+20*d.length+30+30+"px"),legend.enter().append("g").attr("class","legend"));r.append("rect").attr("x",e).attr("y",function(e,t){return c-20*t-40-n}).attr("width",20).attr("height",20).style("fill",function(e){return b(e)}),r.append("text").attr("x",e+30).attr("y",function(e,t){return c-20*t-20-4-n}),legend.selectAll("text").data(d).text(function(e,t,n){return a[n]})}map.drawPlays=function(){i="scrobbles",B()},d3.json("assets/data/playlists.json",function(e,t){C=t});var T,L,O,I,x=d3.select("#map-container").append("div").attr("class","tooltip hidden").attr("aria-hidden","true"),R=d3.select("main").append("div").attr("class","infoContainer hidden").attr("id","infoContainer").attr("role","region").attr("aria-labelledby","music-from cname-heading"),M=d3.select("#infoContainer").append("div").attr("class","cnameDiv").attr("id","cname"),N=(d3.select("#infoContainer").append("div").attr("class","artistContainer").attr("id","artistContainer"),d3.select("#artistContainer").append("div").attr("class","detailsDiv").attr("id","details"),d3.select("#artistContainer").append("div").attr("class","recoDiv").attr("id","recommendations"),d3.select("#artistContainer").append("div").attr("class","artistSummaryDiv").attr("id","summary"),{blue_black:["#03020D","#140E1F","#2A075A","#321C78","#362688","#3E3CA7","#4651C5","#5371F4"],green_black:["#03020D","#08120C","#032F30","#064137","#0E6745","#158C54","#1CB162","#28EA78"],pink_black:["#03020D","#1F0310","#4B0627","#5C1138","#7E285C","#A13F80","#C355A4","#F778DA"],pink_white:["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],green_white:["#ece2f0","#F6EBFA","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c"],red_white:["#F0F0D8","#F0F0D8","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"]}),e=m.nextTheme=function(e){var t=d3.keys(N),e=(n=e||t[(t.indexOf(n)+1)%t.length],colorArray=N[n],["blue_black","green_black","pink_black"].includes(n)?"dark":"light");e+=" "+n,d3.select(f.body).attr("class",e),m.localStorage.theme=n,r&&B(),announcer.announce("Theme changed to ".concat(n))};function D(e,t){u=d3.geo.naturalEarth().translate([e/2,t/2+.08*t]).scale(e/1.7/Math.PI),g=d3.geo.path().projection(u),map.path=g,map.projection=u,o=d3.select("#map-container").attr("role","application").append("svg").attr("role","img").attr("tabindex","0").attr("aria-labelledby","map-label").attr("id","map-svg").attr("width",e).attr("height",t).style("margin-left",f.getElementById("map-container").offsetWidth/2-e/2).call(s).on("click",H).append("g"),y=o.append("g"),o.append("g").attr("id","legend"),o.append("text").attr({id:"filter-text",class:"legend"}),o.append("text").attr({id:"filter",class:"legend"}),map.zoom=s}function P(e,t){e=y.selectAll(".country").data(e);d3.select("#progress-bar").style({height:countryScore/210*100+"%","background-color":colorArray[6]});d3.select("#countryCount").style({"background-color":colorArray[1],"border-color":colorArray[6]}).on("mousemove",function(){d3.select("#progress-text").transition().duration(prefersReducedMotion?0:150).style("opacity",.9)}).on("mouseout",function(){d3.select("#progress-text").transition().duration(prefersReducedMotion?0:150).style("opacity",0)}),d3.select("#progress-text").html("Scrobbled from "+countryScore+"/210 countries").attr("aria-hidden","true"),t&&e.enter().insert("path").attr("class","country").attr("d",g).attr("id",function(e,t){return"c".concat(e.id)}).attr("title",function(e,t){return e.properties.name}).attr("data-center-x",function(e,t){return X(e).x}).attr("data-center-y",function(e,t){return X(e).y}).style("fill",function(){return b(0)}).style("transform-origin",function(e){e=X(e);return"".concat(-e.x,"px ").concat(-e.y,"px")}),e.transition().style("fill",function(e){switch(i){case"artists":return h[e.id]?b(h[e.id].length):b(0);case"scrobbles":return b(A(e))}}),L=f.getElementById("map-container").offsetLeft,O=f.getElementById("map-container").offsetTop,e.on("mousemove",function(n,e){v.forEach(function(e,t){e.id===n.id&&(a=e.name,e.tag)});var a,t=d3.mouse(o.node()).map(function(e){return parseInt(e)});x.classed("hidden",!1).attr("style","left:"+(t[0]+L+20)+"px;top:"+(t[1]+O+10)+"px").html(a+(h[n.id]?"<br>"+h[n.id].length+" artists, "+w(A(n))+" scrobbles":""))}).on("mouseout",function(e,t){x.classed("hidden",!0)}).on("click",function(n,e){G(n),v.forEach(function(e,t){e.id===n.id&&(e.name,e.tag,n.id)}),d3.mouse(o.node()).map(function(e){return parseInt(e)});T.on("click",function(e,t){K(),G(p)})})}function B(e){t(),e&&(d3.select("#map-svg").remove(),D(l,c)),a=d3.max(d3.keys(h),function(e){return h[e].length}),E=d3.max(d3.keys(h),function(e){return A({id:e})}),_(),k(),P(r,e)}function j(e,t,n,a){MIN_ZOOM_LEVEL_FOR_KEYBOARD_MODE<=t?keyboardMode.updateVisibleCountries(s):keyboardMode.cleanup();var r=e||!!d3.event&&d3.event.translate||s.translate(),o=t||!!d3.event&&d3.event.scale||s.scale(),e=(e||t||!p||(W(!1),K(),p=null),c/4);r[0]=Math.min(l/c*(o-1),Math.max(1.2*l*(1-o),r[0])),r[1]=Math.min(e*(o-1)+e*o,Math.max(c*(1-o)-e*o,r[1])),s.translate(r),s.scale(o),(n?y.transition().duration(prefersReducedMotion?0:950):y).attr("transform","translate("+r+")scale("+o+")"),d3.selectAll(".country").style("stroke-width",1.5/o)}function H(){u.invert(d3.mouse(this))}function U(e,t){e=(e-1)*t,e=artists.slice(e,e+t);d3.selectAll(".artist-li").remove(),e.forEach(function(e){var t=d3.select("#top-artist-list").append("li").attr("class","artist-li").append("button").attr({class:"scrobbled artist-div lowlight","data-artist":e.artist}).on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),d3.selectAll(".artist-div").attr("aria-pressed","false"),d3.select(this).attr("aria-pressed","true"),Y(d3.select(this).attr("data-artist"))});t.append("div").style("display","block").append("div").attr("class","artist-image image-div"),t.append("div").attr("class","play-count-div").append("p").html("<strong>"+e.artist+"</strong><br>"+e.playcount+" scrobbles").attr("class","details-p")}),d3.select(".artist-control.left").attr("disabled",1===currentPage?"disabled":null),d3.select(".artist-control.right").attr("disabled",currentPage===Math.ceil(artists.length/t)?"disabled":null)}function F(){currentPage<artists.length/itemsPerPage&&(U(++currentPage,itemsPerPage),announcer.announce("Showing next five artists","polite"),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Next five",eventLabel:"test"}))}function q(){1<currentPage&&(U(--currentPage,itemsPerPage),announcer.announce("Showing previous five artists","polite"),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Previous five",eventLabel:"test"}))}function V(s){S=!0,v.forEach(function(e,t){e.id===s.id&&(c=e.name,l=e.tag,n=(e.names||[e.name]).map(function(e){return'<span class="demonym">'+e+"</span>"}).join(", "),a=(e.tags||[e.tag]).map(function(e){return'<span class="demonym">'+e+"</span>"}).join(", "))}),d3.select("#recommendations").html(""),R.classed("hidden",!1).transition().style("opacity",1).duration(prefersReducedMotion?0:750),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!0),T=d3.select("#infoContainer").append("button").attr("type","button").attr("aria-label","Close ".concat(c)).attr("class","close-button fa fa-xmark"),M.append("div").attr("class","cnameContainer").attr("id","cnameCont").append("h1").html(c).attr("id","cname-heading"),d3.select("#cnameCont").append("strong").html(function(){return h[s.id]?w(h[s.id].length)+" artists, "+w(A(s))+" scrobbles":"No artists yet - Find new here<span aria-hidden> -></span>"});var c,l,n,a,e=C.find(function(e){return e.name===c}),t=d3.select("#cnameCont").append("div").attr("class","playlist-link"),r=t.append("a").attr("href","https://last.fm/tag/"+c),d=(r.append("img").attr("alt","Last.fm tag").attr("class","playlist-link__img").attr("src","https://www.shareicon.net/data/32x32/2016/05/24/769923_logo_512x512.png").attr("style","background:none"),r.append("span").html("#"+c),e&&(t.append("span").attr("class","divider").html("/").attr("aria-hidden","true"),(r=t.append("a").attr("href",e.uri).attr("target","_self")).append("img").attr("alt","Spotify playlist").attr("class","playlist-link__img").attr("src","https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg"),r.append("span").html(e.playlistName)),h[s.id]&&(d3.select("#details").append("h2").html("<span>Your top artists tagged with </span>"+n+"<span> or </span>"+a+"<span>: </span>").attr("class","topartists-desc").attr("id","top-artist-list-heading"),currentPage=1,itemsPerPage=5,artists=h[s.id],d3.select("#details").append("div").attr("id","top-artist-list-container"),d3.select("#top-artist-list-container").append("ol").attr("id","top-artist-list").attr("aria-labelledby","top-artist-list-heading"),d3.select("#top-artist-list-container").append("button").attr("class","fa artist-control left fa-angle-left").attr("aria-label","Previous five artists"),d3.select("#top-artist-list-container").append("button").attr("class","fa artist-control right fa-angle-right").attr("aria-label","Next five artists"),d3.select(".artist-control.left").on("click",q),d3.select(".artist-control.right").on("click",F),U(currentPage,itemsPerPage)),d3.select("#recommendations").append("h2").html("You may like: ").attr("id","recom-heading").attr("class","topartists-desc"),d3.select("#recommendations").append("ul").attr("id","recom-list").attr("aria-labelledby","recom-heading").classed("hidden",!1),d3.select("#recommendations").append("div").attr("class","recLoadingDiv")),u=d.append("span").attr("id","rec-loading").html("Looking for artists tagged #"+l);d.append("img").attr({id:"rec-loading-img",src:"assets/img/loader_horizontal.gif",alt:"Loading..."}).style({display:"inline-block",margin:"0 5px"}),d.append("span").attr("id","rec-loading-current"),api.getRecommendations(l,function(i){p&&p.id===s.id&&(u.html("Looking for artists tagged #"+c),api.getRecommendations(c,function(e){if(p&&p.id===s.id){u.html("Loading images for recommended artists");for(var t,n=i.concat(e),a={},r=0;r<n.length;r++)a[n[r].name]=n[r];for(t in n=new Array,a)n.push(a[t]);n.sort(function(e,t){return t.count<e.count?-1:t.count>e.count?1:0}),0===(n=function(e){for(var t=e.length-1;0<t;t--){var n=Math.floor(Math.random()*(t+1)),a=e[t];e[t]=e[n],e[n]=a}return e}(n=n.slice(0,20))).length&&(d.remove(),d3.select("#recommendations").append("p").html("We couldn't find any good "+l+" recommendations for you :-( "),d3.select("#recommendations").append("a").attr({href:"https://www.last.fm/tag/"+c,target:"_blank"}).html("Try searching last.fm yourself!"));for(var o=0;o<Math.min(n.length,5);o++){if(p.id!==s.id)return;api.getArtistInfo(n[o].name,function(e){d.remove();e[0].url;var t=e[0].image,n=e[0].name,e=d3.select("#recom-list").append("li").insert("button","#summaryText").attr("type","button").attr("class","artist-div lowlight");e.append("div").style("display","block").append("div").attr("class","image-div").style("background-image","url('"+t+"')"),e.append("div").attr("class","recoArtistInfoDiv").append("p").html(n).attr("class","details-p"),e.on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),Y(n)})})}}}))})}function K(){S=!1,api.cancelRecommendationRequests(),R.transition().style("opacity",0).duration(prefersReducedMotion?0:1e3),R.classed("hidden",!0),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!1),d3.select("#details").html(""),d3.select("#recommendations").html(""),d3.select("#cname").html(""),d3.selectAll(".artist-control").remove(),d3.select(".close-button").remove(),d3.selectAll("#top-artist-list").remove()}function Y(l){var d,u=[],p=(d3.select("#summaryText").remove(),d3.select("#recommendations").append("div").attr("class","summaryText").attr("id","summaryText"));d3.select("#summaryText").append("span").html("Loading description of "+l),d3.select("#summaryText").append("img").attr({id:"sum-loading-img",src:"assets/img/loader_horizontal.gif"}).style({display:"inline-block",margin:"0 5px"}),api.getArtistInfo(l,function(e){var t=e[0].description.split(/(\n)+/g);d=e[0].tags;for(var n=0;n<15;n++)for(var a=0;a<d.length;a++)d[a]===USER_TAGS[n].tag&&u.push(USER_TAGS[n].tag);var r=(r=u.concat(d)).filter(function(e,t){return r.indexOf(e)==t});d3.select("#summaryText").html("");for(var e=.9*m.innerHeight-f.getElementById("artistContainer").offsetHeight,o=(p.style("max-height",e+"px"),p.append("h2").html(l).attr("id","artistname"),p.append("ul").attr("class","taglist").attr("aria-labelledby","tags-for artistname")),i=0;i<Math.min(r.length,6);i++)for(var s=o.append("li").attr("class","tagdiv").html(r[i]),c=0;c<u.length;c++)r[i]===u[c]&&s.classed("usertag",!0);t.forEach(function(e){p.append("p").html(e||"No description available - <a href='https://last.fm/music/"+l+"' target='_blank'>check out last.fm.</a>")})})}function W(e,t){d3.selectAll(".country").classed("highlighted",!1),e?(d3.selectAll(".country").transition().style("opacity",function(){return this.id==="c".concat(t.id)?1:.3}),d3.select(f.getElementById("c".concat(t.id))).classed("highlighted",!0)):d3.selectAll(".country").transition().style("opacity",1)}function G(t){keyboardMode.cleanup();var e,n,a,r=g.bounds(t),o=(A(t),r[1][0]-r[0][0]),i=r[1][1]-r[0][1];if(o<80&&(o=80),t&&p!==t)switch(p=t,K(),V(t),W(!0,t),announcer.announce("Opened ".concat(v.find(function(e){return e.id===t.id}).name),"assertive"),t.id){case 840:e=-(r[1][0]+r[0][0])/(a=3),n=-(r[1][1]+r[0][1])/1.7;break;case 250:a=7.012,e=-(r[1][0]+r[0][0])/1.85,n=-(r[1][1]+r[0][1])/3;break;case 528:a=12.0124,e=-(r[1][0]+r[0][0])/1.56,n=-(r[1][1]+r[0][1])/2.7;break;case 643:a=1.9,e=-(r[1][0]+r[0][0])/1.25,n=-(r[1][1]+r[0][1])/2;break;case 554:a=4,e=-(r[1][0]+r[0][0])/.9,n=-(r[1][1]+r[0][1])/1.8;break;case 36:a=3.3,e=-(r[1][0]+r[0][0])/1.8,n=-(r[1][1]+r[0][1])/2.1;break;default:a=.55/Math.max(o/l,i/c),e=-(r[1][0]+r[0][0])/2-l/a/4,n=-(r[1][1]+r[0][1])/2}else announcer.announce("Left ".concat(v.find(function(e){return e.id===t.id}).name),"assertive"),e=-l/2,n=-c/2-.08*c,a=1,K(),W(!1),p=null,f.getElementById("map-svg").focus({preventScroll:!0});var s=u.translate();j([s[0]+e*a,s[1]+n*a],a,!prefersReducedMotion)}function X(e){var t,n,a,r,o,i=e.id;if(COUNTRY_BBOX_OVERRIDES&&COUNTRY_BBOX_OVERRIDES[i])return i=COUNTRY_BBOX_OVERRIDES[i],i=Array.isArray(i[0])?i[0]:i,t=(i=_slicedToArray(i=i,4))[0],n=i[1],t=[(a=i[2])<t?(t+a+360)/2%360:(t+a)/2,(i[3]+n)/2],{x:-(a=u(t))[0],y:-a[1]};var s=g.bounds(e);switch(e.id){case 840:r=-(s[1][0]+s[0][0])/4,o=-(s[1][1]+s[0][1])/1.9;break;case 250:r=-(s[1][0]+s[0][0])/1.94,o=-(s[1][1]+s[0][1])/2.81;break;case 528:r=-(s[1][0]+s[0][0])/1.605,o=-(s[1][1]+s[0][1])/2.54;break;case 643:r=-(s[1][0]+s[0][0])/1.4,o=-(s[1][1]+s[0][1])/2;break;case 554:r=-(s[1][0]+s[0][0])/1.03,o=-(s[1][1]+s[0][1])/1.87;break;case 36:r=-(s[1][0]+s[0][0])/2,o=-(s[1][1]+s[0][1])/2.1;break;default:r=-(s[1][0]+s[0][0])/2,o=-(s[1][1]+s[0][1])/2}return{x:r,y:o}}(map.nextTheme=e)(n),_(),t(),D(l,c),keyboardMode.init(s,j,l,c,MAX_ZOOM),api.getCountriesData().then(function(e){return map.countryNames=v=e}),d3.json("assets/data/world-50m.json",function(e,t){t=topojson.feature(t,t.objects.countries).features;P(r=t,!0)}),map.move=j,m.addEventListener("keydown",function(e){"Escape"!==e.key&&27!==e.keyCode||!S||(console.log("Escape pressed"),K(),G(p))}),map.addArtists=function(e){var t,n,a;Object.entries(e).forEach(function(e){var e=_slicedToArray(e,2),t=e[0],e=e[1];h[t]=(h[t]||[]).concat(e)}),countryScore=0,d3.keys(h).forEach(function(e){countryScore+=1}),r&&B(),m.countryScore=countryScore,t=e,n=m.matchMedia("(prefers-reduced-motion: reduce)").matches,a=y.selectAll(".country").filter(function(e){return!!t[e.id]}),setTimeout(function(){n||a.transition().duration(200).style("opacity","0.8").delay(function(e,t){return 100*t}).transition().duration(150).style("opacity","1")})},map.getCountryCenter=X,map.makeSummaryDiv=Y,map.showArtists=U,map.searchArtist=function(t){var e=artists.findIndex(function(e){return e.artist.toLowerCase()===t.toLowerCase()});-1!==e&&(U(currentPage=Math.floor(e/itemsPerPage)+1,itemsPerPage),setTimeout(function(){var e=f.querySelector('[data-artist="'.concat(t,'"]'));null!=e&&e.click(),setTimeout(function(){null!=e&&e.focus()},50)},250))},map.centered=p,map.dismissCenteredCountry=function(){K(),W(!1),p=null},map.toggleFilter=function(){i="artists"===i?"scrobbles":"artists",k(),B()}}(window,document);
//# sourceMappingURL=sourcemaps/all.min.js.map
