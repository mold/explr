"use strict";function _createForOfIteratorHelper(e,t){var n,r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return r&&(e=r),n=0,{s:t=function(){},n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,i=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){i=!0,a=e},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw a}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function ownKeys(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,o=[],i=!0,s=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(s)throw a}}return o}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}var announcer={},LIVEREGION_TIMEOUT_DELAY=7e3,liveAnnouncer=null;function debounce(r,a){var o;return function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];clearTimeout(o),o=setTimeout(function(){clearTimeout(o),r.apply(void 0,t)},a)}}function announce(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"assertive",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:LIVEREGION_TIMEOUT_DELAY;(liveAnnouncer=liveAnnouncer||new LiveAnnouncer).announce(e,t,n)}function clearAnnouncer(e){liveAnnouncer&&liveAnnouncer.clear(e)}function destroyAnnouncer(){liveAnnouncer&&(liveAnnouncer.destroy(),liveAnnouncer=null)}var LiveAnnouncer=function(){function e(){_classCallCheck(this,e),this.node=document.createElement("div"),this.node.dataset.liveAnnouncer="true",Object.assign(this.node.style,{border:0,clip:"rect(0 0 0 0)",clipPath:"inset(50%)",height:"1px",margin:"-1px",overflow:"hidden",padding:0,position:"absolute",width:"1px",whiteSpace:"nowrap"}),this.assertiveLog=this.createLog("assertive"),this.node.appendChild(this.assertiveLog),this.politeLog=this.createLog("polite"),this.node.appendChild(this.politeLog),document.body.prepend(this.node)}return _createClass(e,[{key:"createLog",value:function(e){var t=document.createElement("div");return t.setAttribute("role","log"),t.setAttribute("aria-live",e),t.setAttribute("aria-relevant","additions"),t}},{key:"destroy",value:function(){this.node&&(document.body.removeChild(this.node),this.node=null)}},{key:"announce",value:function(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"assertive",r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:LIVEREGION_TIMEOUT_DELAY;this.node&&((t=document.createElement("div")).textContent=e,("assertive"===n?this.assertiveLog:this.politeLog).appendChild(t),""!==e&&setTimeout(function(){t.remove()},r))}},{key:"clear",value:function(e){this.node&&(e&&"assertive"!==e||(this.assertiveLog.innerHTML=""),e&&"polite"!==e||(this.politeLog.innerHTML=""))}}]),e}(),auditoryFeedback=(announcer.announce=announce,announcer.clearAnnouncer=clearAnnouncer,announcer.destroyAnnouncer=destroyAnnouncer,announcer.debounce=debounce,function(){var o=null,i=null,s=null,c=!1,l=!0,d=!1,u=null,t=750,p=!1;function r(){u&&clearTimeout(u),u=setTimeout(function(){s&&(s.gain.exponentialRampToValueAtTime(.001,o.currentTime+.5),setTimeout(function(){i&&(i.stop(),i=null,d=!1)},600))},t)}function a(){c=!c,window.announcer&&window.announcer.announce(c?"Audio feedback enabled. Use arrow keys to navigate and hear artist density for the currently visible countries.":"Audio feedback disabled."),c?(p=!0,n()):s&&(s.gain.exponentialRampToValueAtTime(.001,o.currentTime+.5),u&&(clearTimeout(u),u=null))}function m(e){if(o&&c&&(!l||p)){e=220+660*Math.pow(e,.8);if(d)r();else if(o){if(i){try{i.stop()}catch(e){}i=null}i=o.createOscillator(),s=o.createGain(),i.type="sine",i.frequency.value=0,s.gain.value=0,i.connect(s),s.connect(o.destination),i.start(),d=!0,r()}i.frequency.exponentialRampToValueAtTime(e,o.currentTime+.2),s.gain.value<.1&&s.gain.exponentialRampToValueAtTime(.1,o.currentTime+.1)}}function n(){if(c&&(!l||p)){if(window.keyboardMode&&"function"==typeof window.keyboardMode.isActive&&!window.keyboardMode.isActive())return d&&i?void(s&&s.gain.exponentialRampToValueAtTime(.001,o.currentTime+.5)):void 0;var t,n,r,e,a=function(){if(window.keyboardMode&&"function"==typeof window.keyboardMode.getCurrentlyVisibleCountries)return window.keyboardMode.getCurrentlyVisibleCountries();return console.warn("Could not find getCurrentlyVisibleCountries function"),[]}();a&&0!==a.length&&(t=0,Array.isArray(a)&&"object"===_typeof(a[0])&&"artistCount"in a[0]?t=a.reduce(function(e,t){return e+t.artistCount},0):Array.isArray(a)&&"object"===_typeof(a[0])&&"number"in a[0]?t=a.reduce(function(e,t){return e+t.artistCount},0):(n=window.script&&window.script.getCurrentData?window.script.getCurrentData():{},r=window.location.href.split("username=")[1],a.forEach(function(e){n[e]&&n[e][r]&&(t+=n[e][r].length)})),0!==t?(a=0<a.length?t/a.length:0,m(window.map&&window.map.getColorDomain?(e=window.map.getColorDomain())&&0<e.length?(e=e[e.length-1],Math.min(a/e,1)):Math.min(a/100,1):Math.min(a/100,1))):d&&i&&s&&(s.gain.exponentialRampToValueAtTime(.001,o.currentTime+.5),u&&(clearTimeout(u),u=null),setTimeout(function(){i&&(i.stop(),i=null,d=!1)},600)))}}return window.addEventListener("beforeunload",function(){i&&(i.stop(),i=null),u&&(clearTimeout(u),u=null)}),{init:function(){try{document.addEventListener("click",function e(){o||(o=new(window.AudioContext||window.webkitAudioContext),console.log("Audio context initialized on user interaction")),p=!1,document.removeEventListener("click",e)},{once:!0}),document.addEventListener("keydown",function(e){if("a"===e.key.toLowerCase()&&!e.repeat){if("INPUT"===e.target.tagName||!window.keyboardMode||!window.keyboardMode.isActive())return;a()}"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||(p=!0,l&&c&&setTimeout(n,100))}),document.addEventListener("mousemove",function(){p=!1}),document.addEventListener("mousedown",function(){p=!1}),document.addEventListener("wheel",function(){p=!1}),console.log("Auditory feedback module initialized");try{o=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.log("Audio context will be initialized on first user interaction")}}catch(e){console.error("Web Audio API is not supported in this browser",e)}},updateFeedback:n,toggleAudioFeedback:a,isEnabled:function(){return c},setKeyboardOnly:function(e){l=e},setToneDuration:function(e){t=e}}}());document.addEventListener("DOMContentLoaded",function(){auditoryFeedback.init()}),function(){var t=document.getElementById("country-list-button"),u=document.getElementById("country-list-dialog"),e=u.querySelector(".close"),r=u.querySelector(".country-list__continents"),p=["All","Europe","North America","South America","Asia","Africa","Oceania","Antarctica","Other"];function m(e){if(!e||!e.id)return 0;if(!window.countryCountObj||!window.countryCountObj[e.id])return 0;var t=0;return Object.values(window.countryCountObj[e.id]).forEach(function(e){e.forEach(function(e){t+=e.playcount||0})}),t}function h(e){return e&&e.id&&window.countryCountObj&&window.countryCountObj[e.id]?Object.values(window.countryCountObj[e.id]).flat().length:0}function s(e){var n={};return e.forEach(function(e){var t=e.continent||"Other";n[t]||(n[t]=[]),n[t].push(e)}),n}var f="artists",n=0,a=[],o=[],i=null;function g(l,e,t){var d=1<arguments.length&&void 0!==e?e:0,n=2<arguments.length&&void 0!==t?t:null;i||((i=document.createElement("div")).setAttribute("role","tablist"),i.setAttribute("aria-label","Continents"),i.className="country-tabs",a=[],p.forEach(function(e,r){var t;"All"!==e&&!l[e]||((t=document.createElement("button")).setAttribute("role","tab"),t.setAttribute("id","tab-".concat(e)),t.setAttribute("aria-controls","tabpanel-".concat(e)),t.className="country-tab",t.textContent="All"===e?"All":e,t.addEventListener("click",function(){return c(r)}),t.addEventListener("keydown",function(e){var t=r,n=t;if("ArrowRight"===e.key){for(;n=(n+1)%a.length,!a[n];);a[n].focus(),e.preventDefault()}else if("ArrowLeft"===e.key){for(;n=(n-1+a.length)%a.length,!a[n];);a[n].focus(),e.preventDefault()}else"Home"===e.key?(a[0].focus(),e.preventDefault()):"End"===e.key?(a[a.length-1].focus(),e.preventDefault()):"Enter"!==e.key&&" "!==e.key||(c(t),e.preventDefault())}),a.push(t),i.appendChild(t))}),r.appendChild(i),o=[],p.forEach(function(e,t){var n;"All"!==e&&!l[e]||((n=document.createElement("div")).setAttribute("role","tabpanel"),n.setAttribute("id","tabpanel-".concat(e)),n.setAttribute("aria-labelledby","tab-".concat(e)),n.className="country-tabpanel",o.push(n),r.appendChild(n))})),a.forEach(function(e,t){e.setAttribute("aria-selected",t===d?"true":"false"),e.setAttribute("tabindex",t===d?"0":"-1"),t===d&&null!==n&&setTimeout(function(){e.focus()},0)}),o.forEach(function(e,t){var n,r,a,i,o,s,c;e.hidden=t!==d,t===d?(e.innerHTML="",n=p[t],(r=document.createElement("div")).className="country-tabpanel-heading-row",(a=document.createElement("h2")).className="country-tabpanel-heading",a.textContent="All"===n?"All countries":n,r.appendChild(a),(a=document.createElement("div")).className="country-sort-container",(o=document.createElement("span")).className="country-sort-label",o.textContent="Sort",a.appendChild(o),s=function(){g(l,t,t,"center")},(c=document.createElement("select")).className="country-sort-select",c.setAttribute("aria-label","Sort countries"),[{value:"artists",label:"Most artists"},{value:"scrobbles",label:"Most scrobbles"},{value:"alpha",label:"A–Z"}].forEach(function(e){var t=document.createElement("option");t.value=e.value,t.textContent=e.label,e.value===f&&(t.selected=!0),c.appendChild(t)}),c.addEventListener("change",function(e){f=c.value,s()}),a.appendChild(c),r.appendChild(a),e.appendChild(r),(i=document.createElement("ul")).className="country-list",o="All"===n?Object.values(l).flat():l[n],(o="artists"===f?o.slice().sort(function(e,t){return h(t)-h(e)}):"scrobbles"===f?o.slice().sort(function(e,t){return m(t)-m(e)}):o.slice().sort(function(e,t){return e.name.localeCompare(t.name)})).forEach(function(t){var e,n=document.createElement("li"),r=(n.className="country-list__country",document.createElement("button")),a=(r.type="button",r.className="country-list__country-btn",document.createElement("span")),o=(a.className="country-list__country-name",a.textContent=t.name,document.createElement("span"));o.className="country-list__country-count","scrobbles"===f?(e=m(t),o.textContent=e.toLocaleString()+" scrobbles"):(e=h(t),o.textContent=e+" artists"),r.appendChild(a),r.appendChild(o),r.onclick=function(){u.close(),setTimeout(function(){var e=document.getElementById("c"+t.id);e&&e.dispatchEvent(new Event("click"))},100)},n.appendChild(r),i.appendChild(n)}),e.appendChild(i)):e.innerHTML=""})}function c(e){var t="center";"number"==typeof n&&(n<e?t="end":e<n&&(t="start")),g(window.map&&window.map.countryNames?s(window.map.countryNames):{},e,e,t),n=e}t.addEventListener("click",function(){var e;window.map&&window.map.countryNames&&(e=s(window.map.countryNames),n=0,a=[],o=[],i=null,r.innerHTML="",g(e,0,0,"center"),u.showModal(),setTimeout(function(){return u.querySelector("h1").focus()},100))}),e.addEventListener("click",function(){u.close(),t.focus(),f="artists"}),u.addEventListener("keydown",function(e){"Escape"===e.key&&(u.close(),t.focus(),f="artists")})}();(api=api||{}).lastfm={},api.lastfm.key="865b1653dbe200905a5b75d9d839467a",api.lastfm.url="https://ws.audioscrobbler.com/2.0/",function(f){function h(e,t){b[e].total++,b[e].success+=t?1:0,b[e].fails+=t?0:1}var g=0,y=["7a9619a850ccf7377c46cf233c51e3c6","13893ba930c63b1b2cbe21441dc7f550","4cb074e4b8ec4ee9ad3eb37d6f7eb240","4a9f5581a9cdf20a699f540ac52a95c9","57ee3318536b23ee81d6b27e36997cde","865b1653dbe200905a5b75d9d839467a","68b2125fd8f8fbadeb2195e551f32bc4","1ba315d4d1673bbf88aed473f1917306"],b=window.keyInfo={};y.forEach(function(e){return b[e]={success:0,fails:0,total:0}});f.lastfm.send=function(i,s,e,c){c=void 0===c?10:c;var l,d,u=!1;function p(r,a){t=y.reduce(function(e,t,n,r){return e+b[t].fails/r.length},0);var t,e,n,o=(e=(e=y.filter(function(e){return b[e].fails<=t})).length?e:y)[++g%e.length];l=d3.json((n=f.lastfm.url+"?method="+i+"&api_key="+o+"&format=json",s.forEach(function(e){n+="&"+e[0]+"="+(e[1]+"").replace("&","%26").replace("/","%2F").replace("+","%2B").replace("\\","%5C")}),n),function(e,t){if(u)clearTimeout(m);else{if(e?t=JSON.parse(e.response):t.error&&(e=t),e){h(o,!1);var n={method:i,errorCode:e&&e.error,try:r,options:s,key:o,message:e.message||(null===(n=JSON.parse(e.response))||void 0===n?void 0:n.message)};if(r<c)return console.warn("Retry request: ",n),void setTimeout(p.bind(null,r+1,a),3e3*r);c<=r&&(console.warn("Retry failed after "+c+" attempts, will stop trying.",n),clearTimeout(m),u=!0,e="ERROR",t={error:"Took to long to respond"})}else h(o,!0);d=!0,a(e,t)}})}p(0,e);var m=setTimeout(function(){d||(l.abort(),e("ERROR",{error:"Took to long to respond"}))},2e4);return{abort:function(){u=!0,l.abort()}}}}(api);var typingTimeout,api=api||{},superCount=0,utils=(!function(){api.getCountriesData=(console.log("Loading countries data..."),function(){return e=e||new Promise(function(n,e){d3.csv("assets/data/countries.csv",function(e,t){t.forEach(function(e){e.id=+e.id,e.names=e.names?e.names.split("|"):[],e.tags=e.tags?e.tags.split("|"):[],e.mainName=e.names[0],e.tag=e.tags[0],e.name=e.mainName,e.continent=e.continent||""}),n(t)})})}),Promise.all([api.getCountriesData(),new Promise(function(n,r){return d3.json("assets/data/artist-countries.json",function(e,t){return e?r(e):n(t)})})]).then(function(e){var e=_slicedToArray(e,2),t=e[0],n=e[1],t=t.map(function(t){var e=[];return 1===t.names.length&&0===t.tags.length&&(e=[t]),1<t.names.length&&(e=e.concat(t.names.map(function(e){return _objectSpread(_objectSpread({},t),{},{name:e})}))),0<t.tags.length&&(e=e.concat(t.tags.map(function(e){return _objectSpread(_objectSpread({},t),{},{tag:e})}))),1<t.names.length&&0<t.tags.length&&e.splice(0,1),e}).flat(),s=d3.nest().key(function(e){return e&&e.tag?e.tag.toLowerCase():""}).map(t),c=d3.nest().key(function(e){return e.name.toLowerCase()}).map(t);api.getCountry=function(o,i){var e;if(n[o])return e=n[o].toLowerCase(),console.log('Using hardcoded country tag "'.concat(e,'" for artist "').concat(o,'"')),void i({artist:o,tag:e,id:c[e][0].id,country:c[e][0].mainName});api.lastfm.send("artist.gettoptags",[["artist",o]],function(e,t){var r,a,n;!e&&t.toptags&&t.toptags.tag&&t.toptags.tag.length?(e=[].concat(["georgia","ireland"],["spanish","french","english","portuguese","russian","italian","japanese","korean","indian","swedish","irish"]),a=r={tag:"",id:null,country:"",count:0},t.toptags.tag.some(function(e,t){var n=e.name.toLowerCase();if(a.id&&r.id)return!0;try{!a.id&&c[n]&&c[n][0].id&&(a={tag:n,id:c[n][0].id,country:c[n][0].mainName,count:e.count}),!r.id&&s[n]&&s[n][0].id&&(r={tag:n,id:s[n][0].id,country:s[n][0].name,count:e.count})}catch(e){}}),n=a.id&&r.count<8*a.count?a:r.id?r:{},"georgia"===a.tag&&t.toptags.tag.some(function(e){return["american","us","usa"].includes(e.name.toLowerCase())})&&(n=r,console.info("'"+o+"' is tagged with 'georgia', but I'm gonna go ahead and guess they're really from the U.S.")),e.includes(n.tag)&&console.info("Potentially incorrect country for '"+o+"': "+n.country+", using the tag '"+n.tag+"'"),i(Object.assign({artist:o},n))):i({artist:o})})},api.getCountries=function(e,t){function r(){n++,superCount++,script.setLoadingStatus("Loading artists, please wait... (".concat(superCount," / ").concat(SESSION.total_artists,")")),d3.select("#loading-text").html("Loading artists...<br>("+superCount+"/"+SESSION.total_artists+")<br>You can start exploring,<br>but it might interfere<br>with loading your artists."),n===e.length&&localforage.setItem("artists",STORED_ARTISTS,function(e){e&&console.error("Failed saving artists to storage: ",e),t(a)})}var a=[],n=0;e.forEach(function(t,e){var n;STORED_ARTISTS[t]&&STORED_ARTISTS[t].country?((n=STORED_ARTISTS[t].country).artist=t,a.push(n),r()):((new Date).getTime(),api.getCountry(t,function(e){STORED_ARTISTS[t]=STORED_ARTISTS[t]||{},STORED_ARTISTS[t].country={id:e.id,name:e.name},a.push(e),r()}))})}}),api.getTags=function(n,r){STORED_ARTISTS[n]&&STORED_ARTISTS[n].tags?r(STORED_ARTISTS[n].tags):(STORED_ARTISTS[n]=STORED_ARTISTS[n]||{},STORED_ARTISTS[n].tags=[],api.lastfm.send("artist.gettoptags",[["artist",n]],function(e,t){STORED_ARTISTS[n].tags=t.toptags.tag,localforage.setItem("artists",STORED_ARTISTS,function(e){e&&console.error("Failed saving artists to storage: ",e),r(STORED_ARTISTS[n].tags)})}))},api.getArtistInfo=function(r,a){var o=[];api.lastfm.send("artist.getinfo",[["artist",r]],function(e,t){var n=[];t.artist.tags.tag&&t.artist.tags.tag.forEach(function(e,t){n.push(e.name)}),o.push({name:r,url:t.artist.url,image:t.artist.image[3]["#text"],description:t.artist.bio.summary,tags:n}),a(o)})};var e,n=[];api.cancelRecommendationRequests=function(){n.forEach(function(e){e.abort()}),n=[]},api.getRecommendations=function(c,l){api.cancelRecommendationRequests();var d=[],e=USER_TAGS.slice(0,15),u=d3.nest().key(function(e){return e.tag}).rollup(function(e){return e[0].count}).map(e),e=api.lastfm.send("tag.gettopartists",[["tag",c],["limit",100]],function(e,t){var i,s={};!e&&!t.error&&t.topartists&&t.topartists.artist?(i=t.topartists.artist).forEach(function(a,o){s[a.name]=[];var e=api.lastfm.send("artist.gettoptags",[["artist",a.name]],function(e,t){var n=!t.error&&!!t.toptags.tag;if((d3.select("#rec-loading-current").html("("+a.name+")"),n)&&d3.nest().key(function(e){return e.name}).map(t.toptags.tag)[c])for(var r=t.toptags.tag.length-1;0<=r;r--)u[t.toptags.tag[r].name]&&5<t.toptags.tag[r].count&&s[a.name].push(t.toptags.tag[r].name);o===i.length-1&&(d3.keys(s).forEach(function(e){d.push({name:e,count:s[e].length,tags:s[e]})}),d.sort(function(e,t){return t.count<e.count?-1:t.count>e.count?1:0}),l(d))});n.push(e)}):l([])});n.push(e)},api.getFriends=function(e){api.lastfm.send("user.getFriends",[["user",SESSION.name]],e)}}((window,document)),utils||{}),screenshot=(utils.exportToCSV=function(n){var e=map.countryNames.map(function(e){var t=n[e.id];return{countryId:e.id,countryName:e.mainName,artists:t&&t[SESSION.name]||[]}}),e="data:text/csv;charset=utf-8,"+(e=json2csv.parse(e.sort(function(e,t){e=e.countryName,t=t.countryName;return e.localeCompare(t,"en")}),{fields:[{label:"Country",value:"countryName"},{label:"Number of artists",value:function(e){return e.artists.length}},{label:"Scrobbles",value:function(e){return e.artists.reduce(function(e,t){return e+t.playcount},0)}}]})).replaceAll('"',"");window.open(encodeURI(e))},utils.getCountryNameFromId=function(t){var e=map.countryNames.find(function(e){return e.id===t});return e&&e.mainName?e.mainName:""},utils.getNumberOfArtistsForCountry=function(t){var e=script.getCurrentData(),n=(n=[]).concat.apply(n,_toConsumableArray(Object.values(e)));(n=n.reduce(function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e=e.concat(t[n]));return e},[])).filter(function(e){return e.id===t});return n.filter(function(e){return e.id===t}).length},{}),search=(!function(t,u){screenshot.render=function(){function n(e){s.font=e.font,s.fillText(e.string,a/2-s.measureText(e.string).width/2,e.y),e.lineWidth&&(s.lineWidth=e.lineWidth,s.strokeStyle=e.strokeStyle,s.strokeText(e.string,a/2-s.measureText(e.string).width/2,e.y))}var d=0<arguments.length&&void 0!==arguments[0]&&arguments[0],r=new Image,e=d3.select("#map-svg"),a=e.attr("width"),o=e.attr("height"),i=u.createElement("canvas"),s=i.getContext("2d"),c=t.getComputedStyle(u.body).backgroundColor,l=t.getComputedStyle(u.body).color;i.width=a,i.height=o,e.insert("rect","g").attr({id:"background-rect",width:"100%",height:"100%"}).style({fill:c}),d3.selectAll(".legend text, text.legend").style({"font-family":function(){return t.getComputedStyle(this).fontFamily},"font-size":function(){return t.getComputedStyle(this).fontSize},fill:l}),d3.selectAll(".legend rect").style({stroke:c}),canvg(i,(new XMLSerializer).serializeToString(e[0][0])),r.onload=function(){s.save(),s.globalAlpha=.6,s.fillStyle=c;var e=SESSION.total_artists+" artists from "+countryScore+" / 210 countries",t=SESSION.name+"'s musical world map",t=(s.font="34px Patua One",s.fillRect(a/2-s.measureText(t).width/2-20,o-110,s.measureText(t).width+40,100),s.fillStyle=l,s.fillStyle=l,n({string:t,font:"34px Patua One",y:o-60}),n({string:e,font:"20px Didact Gothic",y:o-40}),s.restore(),s.drawImage(r,a-130,o-60,100,36),d3.select("#background-rect").remove(),u.getElementById("screenshot-img").src=i.toDataURL("image/png"),i.toDataURL("image/png"),u.getElementsByClassName("screenshot-overlay")[0]);t.style="",t.ariaModal=!0,d&&setTimeout(function(){screenshot.download(),screenshot.close()},0)},r.src="assets/img/explrlogo.png"},screenshot.close=function(){u.getElementsByClassName("screenshot-overlay")[0].style="display:none;",u.getElementsByClassName("screenshot-overlay")[0].ariaModal=!1},screenshot.download=function(){var e=u.getElementById("screenshot-img").src,t=u.createElement("a");t.href=e,t.download="screenshot.png",u.body.appendChild(t),t.click(),u.body.removeChild(t)}}(window,document),search||{}),SEARCH_IS_OPEN=!1,searchButton=null,filteredCountries=[],filteredArtists=[],filteredCountryArtists=[],noCountryArtists=[],filteredShortcuts=[],keyboardMode=(search.getAnnouncement=function(){var e,t=[],n=document.querySelector("input.search"),r=filteredArtists.slice(0,100).length+filteredCountryArtists.slice(0,100).length+noCountryArtists.slice(0,100).length;0<filteredShortcuts.length&&3<n.value.length&&(e=1===filteredShortcuts.length?"shortcut":"shortcuts",t.push("".concat(filteredShortcuts.length," ").concat(e))),0<filteredCountries.slice(0,5).length&&1<n.value.length&&(e=1===filteredCountries.length?"country":"countries",t.push("".concat(filteredCountries.length," ").concat(e))),r&&1<n.value.length&&(e=1===r?"artist":"artists",t.push("".concat(r," ").concat(e)));return 0<t.length?"Showing "+t.slice(0,-1).join(", ")+(1<t.length?" and ":"")+t.slice(-1)+", press down arrow to go to results":"No results found"},search.initSearch=function(){SEARCH_IS_OPEN=!0;var a=null,t=null,e=document.querySelector("#search-button"),n=(e&&(e.ariaExpanded=!0),api.getCountriesData().then(function(e){t=e}).catch(function(e){console.error(e)}),[{name:"Status",onClick:function(){}},{name:"Clear cached users",onClick:function(){clearExplrCache().then(function(){return window.location.reload()})}},{name:"Change user",onClick:function(){window.location="./"}},{name:"Change theme",onClick:function(){map.nextTheme()}},{name:"Download screenshot of map",onClick:function(){screenshot.render(!0)}},{name:"Export data",onClick:function(){utils.exportToCSV(script.getCurrentData())}},{name:"Map: Toggle between artists or scrobbles",onClick:function(){map.toggleFilter()}},{name:"Support Explr on BuyMeACoffee",onClick:function(){window.open("https://www.buymeacoffee.com/explrfm","_blank")}},{name:"View Explr on GitHub",onClick:function(){window.open("https://github.com/mold/explr","_blank")}}]),e=script.getCurrentData(),r=(o=[]).concat.apply(o,_toConsumableArray(Object.values(e))),o=(r=(r=r.reduce(function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e=e.concat(t[n]));return e},[])).sort(function(e,t){return t.playcount-e.playcount}),document.getElementById("search-container")),e=(o.classList.add("search-container"),document.createElement("div")),u=(e.classList.add("search-input-wrapper"),document.createElement("input")),s=(u.type="text",u.classList.add("search"),u.placeholder="Search for an artist or a country",u.setAttribute("aria-label","Search for an artist or a country"),u.setAttribute("aria-autocomplete","list"),u.setAttribute("aria-controls","search-results"),u.setAttribute("aria-expanded","false"),u.role="combobox",e.appendChild(u),o.appendChild(e),setTimeout(function(){u.focus()},50),document.createElement("div"));s.classList.add("search-results"),s.id="search-results",s.setAttribute("role","listbox"),s.setAttribute("aria-label","Search results"),o.appendChild(s),u.addEventListener("input",function(){s.innerHTML="",u.setAttribute("aria-expanded","true");var a,o,i,c,l,d,e=n.filter(function(e){return"Status"!==e.name});0<(filteredShortcuts=e.filter(function(e){return"shortcuts"===u.value.toLowerCase()||e.name.toLowerCase().includes(u.value.toLowerCase())})).length&&3<u.value.length&&(a=document.createElement("ul"),(o=document.createElement("li")).textContent="Explr.fm shortcuts",o.id="shortcuts-heading",o.role="presentation",o.classList.add("search-result-heading"),a.appendChild(o),a.setAttribute("role","group"),a.classList.add("search-result-group"),a.ariaLabelledby="shortcuts-heading",s.appendChild(a),filteredShortcuts.forEach(function(e){var t,n,r;3<u.value.length&&("Status"===e.name&&(o.textContent="Explr.fm status"),(t=document.createElement("div")).classList.add("result-wrapper"),t.role="option",t.id="shortcut-".concat(e.name.replace(/\s+/g,"-").toLowerCase()),t.addEventListener("click",function(){e.onClick()}),(n=document.createElement("span")).classList.add("shortcut-name"),r=new RegExp(u.value,"gi"),r=("Status"===e.name?script.getLoadingStatus():e.name).replace(r,function(e){return'<span class="highlight">'.concat(e,"</span>")}),n.innerHTML=r,t.appendChild(n),a.appendChild(t))})),0<(filteredCountries=t.filter(function(e){return e.names.some(function(e){return e.toLowerCase().includes(u.value.toLowerCase())})})).length&&1<u.value.length&&(i=document.createElement("ul"),(e=document.createElement("li")).textContent="Countries",e.classList.add("search-result-heading"),e.id="countries-heading",e.role="presentation",i.appendChild(e),i.setAttribute("role","group"),i.classList.add("search-result-group"),i.setAttribute("aria-labelledby","countries-heading"),s.appendChild(i),filteredCountries.slice(0,5).forEach(function(t){var e,n,r,a;1<u.value.length&&((e=document.createElement("div")).classList.add("result-wrapper","country"),e.role="option",e.id="country-".concat(t.name.replace(/\s+/g,"-").toLowerCase()),e.addEventListener("click",function(){search.stopSearch();var e=document.querySelector(".country#c".concat(t.id));e&&(e.dispatchEvent(new Event("click")),setTimeout(function(){document.querySelector("#cnameCont h1").setAttribute("tabindex","-1"),document.querySelector("#cnameCont h1").focus()},250))}),(n=document.createElement("span")).classList.add("country-name"),(r=document.createElement("span")).classList.add("country-artist-count"),r.textContent="".concat(utils.getNumberOfArtistsForCountry(t.id)," artists"),a=new RegExp(u.value,"gi"),a=t.name.replace(a,function(e){return'<span class="highlight">'.concat(e,"</span>")}),n.innerHTML=a,e.appendChild(n),e.appendChild(r),i.appendChild(e))})),0<(filteredArtists=r.filter(function(e){return e.artist.toLowerCase().includes(u.value.toLowerCase())})).length&&1<u.value.length&&((c=document.createElement("ul")).classList.add("search-result-group"),(e=document.createElement("li")).textContent="Artists",e.role="presentation",e.classList.add("search-result-heading"),e.id="artists-heading",c.appendChild(e),c.setAttribute("role","group"),c.setAttribute("aria-labelledby","artists-heading"),s.appendChild(c),filteredArtists.slice(0,100).forEach(function(t){var e,n,r,a,o,i,s;1<u.value.length&&((e=document.createElement("div")).classList.add("result-wrapper"),e.role="option",e.id="artist-".concat(t.artist.replace(/\s+/g,"-").toLowerCase()),e.addEventListener("click",function(){search.stopSearch(),utils.getCountryNameFromId(t.id)||window.open(t.url,"_blank");var e=document.querySelector(".country#c".concat(t.id));e&&(e.dispatchEvent(new Event("click")),setTimeout(function(){map.searchArtist(t.artist)},250))}),(n=document.createElement("span")).classList.add("artist-wrapper"),(r=document.createElement("span")).classList.add("country-wrapper"),(a=document.createElement("span")).classList.add("visually-hidden"),a.textContent=", from ",(o=document.createElement("span")).classList.add("playcount"),o.textContent="".concat(t.playcount," scrobbles"),(s=document.createElement("span")).classList.add("artist-name"),i=new RegExp(u.value,"gi"),i=t.artist.replace(i,function(e){return'<span class="highlight">'.concat(e,"</span>")}),s.innerHTML=i,n.appendChild(s),n.appendChild(o),(i=document.createElement("span")).classList.add("country-name"),i.textContent=utils.getCountryNameFromId(t.id)?utils.getCountryNameFromId(t.id):"Unknown country :-(",r.appendChild(i),r.prepend(a),utils.getCountryNameFromId(t.id)||((s=document.createElement("span")).classList.add("add-tags"),s.textContent="Go add some tags on Last.fm!",r.appendChild(s)),e.appendChild(n),e.appendChild(r),c.appendChild(e),c.classList.add("artists-wrapper"))})),0<(filteredCountryArtists=r.filter(function(e){return 1===filteredCountries.length&&filteredCountries[0].id===e.id})).length&&1<u.value.length&&((l=document.createElement("ul")).classList.add("search-result-group"),(e=document.createElement("li")).textContent="Artists from "+filteredCountries[0].name,e.role="presentation",e.classList.add("search-result-heading"),e.id="artists-country-heading",l.appendChild(e),l.setAttribute("role","group"),l.setAttribute("aria-labelledby","artists-country-heading"),s.appendChild(l),filteredCountryArtists.slice(0,100).forEach(function(t){var e,n,r,a,o,i,s;1<u.value.length&&((e=document.createElement("div")).classList.add("result-wrapper"),e.role="option",e.id="".concat(filteredCountries[0].name,"-artist-").concat(t.artist.replace(/\s+/g,"-").toLowerCase()),e.addEventListener("click",function(){search.stopSearch();var e=document.querySelector(".country#c".concat(t.id));e&&(e.dispatchEvent(new Event("click")),setTimeout(function(){map.searchArtist(t.artist)},250))}),(n=document.createElement("span")).classList.add("artist-wrapper"),(r=document.createElement("span")).classList.add("country-wrapper"),(a=document.createElement("span")).classList.add("visually-hidden"),a.textContent=", from ",(o=document.createElement("span")).classList.add("playcount"),o.textContent="".concat(t.playcount," scrobbles"),(i=document.createElement("span")).classList.add("artist-name"),s=new RegExp(u.value,"gi"),s=t.artist.replace(s,function(e){return'<span class="highlight">'.concat(e,"</span>")}),i.innerHTML=s,n.appendChild(i),n.appendChild(o),r.textContent=utils.getCountryNameFromId(t.id),r.prepend(a),e.appendChild(n),e.appendChild(r),l.appendChild(e),l.classList.add("artists-wrapper"))})),0<(noCountryArtists=r.filter(function(e){return"unknown"===u.value.toLowerCase()&&!e.id})).length&&1<u.value.length&&((d=document.createElement("ul")).classList.add("search-result-group"),(e=document.createElement("li")).textContent="Artists without a country (first 100)",e.role="presentation",e.classList.add("search-result-heading"),e.id="unknown-artists-heading",d.appendChild(e),d.setAttribute("role","group"),d.setAttribute("aria-labelledby","unknown-artists-heading"),s.appendChild(d),noCountryArtists.slice(0,100).forEach(function(t){var e,n,r,a,o,i,s;1<u.value.length&&((e=document.createElement("div")).classList.add("result-wrapper"),e.role="option",e.id="artist-".concat(t.artist.replace(/\s+/g,"-").toLowerCase()),e.addEventListener("click",function(){search.stopSearch(),utils.getCountryNameFromId(t.id)||window.open(t.url,"_blank");var e=document.querySelector(".country#c".concat(t.id));e&&(e.dispatchEvent(new Event("click")),setTimeout(function(){map.searchArtist(t.artist)},250))}),(n=document.createElement("span")).classList.add("artist-wrapper"),(r=document.createElement("span")).classList.add("country-wrapper"),(a=document.createElement("span")).classList.add("visually-hidden"),a.textContent=", from ",(o=document.createElement("span")).classList.add("playcount"),o.textContent="".concat(t.playcount," scrobbles"),(s=document.createElement("span")).classList.add("artist-name"),i=new RegExp(u.value,"gi"),i=t.artist.replace(i,function(e){return'<span class="highlight">'.concat(e,"</span>")}),s.innerHTML=i,n.appendChild(s),n.appendChild(o),(i=document.createElement("span")).classList.add("country-name"),i.textContent=utils.getCountryNameFromId(t.id)?utils.getCountryNameFromId(t.id):"Unknown country :-(",r.appendChild(i),r.prepend(a),utils.getCountryNameFromId(t.id)||((s=document.createElement("span")).classList.add("add-tags"),s.textContent="Go add some tags on Last.fm!",r.appendChild(s)),e.appendChild(n),e.appendChild(r),d.appendChild(e),d.classList.add("artists-wrapper"))})),clearTimeout(typingTimeout),typingTimeout=setTimeout(function(){announcer.announce(search.getAnnouncement(),"polite")},750)}),window.addEventListener("keydown",function(e){var t,n,r=document.querySelector(".search");a&&(8===e.keyCode||65<=e.keyCode&&e.keyCode<=90)&&(a.removeAttribute("aria-selected"),a.classList.remove("focused"),r.removeAttribute("aria-activedescendant"),a=null,s.scrollTop=0),40===e.keyCode&&SEARCH_IS_OPEN&&(e.preventDefault(),a?(a.removeAttribute("aria-selected"),a.classList.remove("focused"),r.removeAttribute("aria-activedescendant"),(t=a.nextElementSibling)||(n=a.parentElement.nextElementSibling)&&(t=n.querySelector(".result-wrapper")),(a=t)&&(a.classList.add("focused"),a.setAttribute("aria-selected","true"),r.setAttribute("aria-activedescendant",a.id),a.scrollIntoView({behavior:"smooth",block:"nearest"}))):((a=document.querySelector(".result-wrapper")).classList.add("focused"),a.setAttribute("aria-selected","true"),r.setAttribute("aria-activedescendant",a.id),a.scrollIntoView({behavior:"smooth",block:"nearest"}))),38===e.keyCode&&SEARCH_IS_OPEN&&(e.preventDefault(),a&&(a.classList.remove("focused"),a.removeAttribute("aria-selected"),r.removeAttribute("aria-activedescendant"),(n=a.previousElementSibling.classList.contains("search-result-heading")?null:a.previousElementSibling)||((t=a.parentElement.previousElementSibling)?n=(t=t.querySelectorAll(".result-wrapper"))[t.length-1]:(t=(t=document.querySelectorAll(".search-result-group"))[t.length-1])&&(n=(t=t.querySelectorAll(".result-wrapper"))[t.length-1])),(a=n)&&(a.classList.add("focused"),a.setAttribute("aria-selected","true"),r.setAttribute("aria-activedescendant",a.id),a.scrollIntoView({behavior:"smooth",block:"nearest"})))),13===e.keyCode&&SEARCH_IS_OPEN&&(e.preventDefault(),(t=r.getAttribute("aria-activedescendant"))?(n=document.getElementById(t))&&n.dispatchEvent(new Event("click")):(console.log("no active descendant"),(r=document.querySelector(".result-wrapper"))&&r.dispatchEvent(new Event("click")))),27===e.keyCode&&SEARCH_IS_OPEN&&search.stopSearch()}),window.addEventListener("click",function(e){SEARCH_IS_OPEN&&!e.target.closest(".search-container")&&search.stopSearch()})},search.stopSearch=function(){var e=document.querySelector("#search-button"),t=document.querySelector(".search"),t=(void 0!==t&&(t.removeAttribute("aria-activedescendant"),t.setAttribute("aria-expanded","false")),document.querySelector(".search-container"));t&&(t.innerHTML=""),e&&(e.focus({preventScroll:!0}),e.ariaExpanded=!1),SEARCH_IS_OPEN=!1},search.getSearchStatus=function(){return SEARCH_IS_OPEN},search.setSearchStatus=function(e){SEARCH_IS_OPEN=e},window.initSearch=search.initSearch,keyboardMode||{}),MIN_ZOOM_LEVEL_FOR_KEYBOARD_MODE=7,MAX_COUNTRY_SUGGESTIONS=20,KEYBOARD_MODE_ACTIVE=!1,NUMBER_POOL=Array.from({length:99},function(e,t){return(t+1).toString()}),visibleCountries=[],keyBuffer="",keyBufferTimer=null,keyboardModeActive=!1,isKeyboardModeEnabled=!1,currentFocus=null,EXCLUDED_COUNTRY_IDS=[831,832,833,136,796],countryNumberMap={},numberBuffer="",numberBufferTimer=null,NUMBER_BUFFER_TIMEOUT=1e3,handleNumberKeyPress=function(e){if(e.key.match(/^[0-9]$/)&&"INPUT"!==e.target.tagName&&!(e.ctrlKey||e.altKey||e.shiftKey||e.metaKey))if(!(numberBuffer=(numberBuffer+=e.key).replace(/^0+/,""))||2<numberBuffer.length)numberBuffer="";else{var t;if(2===numberBuffer.length)return(t=Object.keys(countryNumberMap).find(function(e){return countryNumberMap[e]===numberBuffer}))?((e=visibleCountries.find(function(e){return e.id===t}))&&((e=d3.select("#".concat(e.id)).node())&&(e.dispatchEvent(new Event("click")),keyboardMode.cleanup()),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Opened country",eventLabel:"test"})),numberBuffer="",clearTimeout(numberBufferTimer),void(numberBufferTimer=null)):(clearTimeout(numberBufferTimer),void(numberBufferTimer=setTimeout(function(){numberBuffer=""},NUMBER_BUFFER_TIMEOUT)));if(!Object.values(countryNumberMap).some(function(e){return 2===e.length&&e.startsWith(numberBuffer)})){var n=Object.keys(countryNumberMap).find(function(e){return countryNumberMap[e]===numberBuffer});if(n)return(e=visibleCountries.find(function(e){return e.id===n}))&&((e=d3.select("#".concat(e.id)).node())&&(e.dispatchEvent(new Event("click")),keyboardMode.cleanup()),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Opened country",eventLabel:"test"})),numberBuffer="",clearTimeout(numberBufferTimer),void(numberBufferTimer=null)}clearTimeout(numberBufferTimer),numberBufferTimer=setTimeout(function(){var t,e;1===numberBuffer.length&&(!(t=Object.keys(countryNumberMap).find(function(e){return countryNumberMap[e]===numberBuffer}))||(e=visibleCountries.find(function(e){return e.id===t}))&&((e=d3.select("#".concat(e.id)).node())&&(e.dispatchEvent(new Event("click")),keyboardMode.cleanup()),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Opened country",eventLabel:"test"}))),numberBuffer=""},NUMBER_BUFFER_TIMEOUT)}};function getCurrentlyVisibleCountries(){var a=window.location.href.split("username=")[1],o=script.getCurrentData(),i=[];return o&&a?visibleCountries.forEach(function(e){var t,n,r=parseInt(e.id.slice(1));EXCLUDED_COUNTRY_IDS.includes(r)||(e=countryNumberMap[e.id],t=o[r]&&o[r][a]?o[r][a].length:0,(n=utils.getCountryNameFromId(r))&&"undefined"!==n&&i.push({name:n,number:e,artistCount:t,id:r}))}):console.warn("Data or username not available"),i}function isInViewport(e){var t=parseInt(e.id.slice(1));if(EXCLUDED_COUNTRY_IDS.includes(t))return!1;if(map.COUNTRY_BBOX_OVERRIDES&&map.COUNTRY_BBOX_OVERRIDES[t])return t=map.COUNTRY_BBOX_OVERRIDES[t],(Array.isArray(t[0])?t:[t]).some(function(e){return isBBoxInViewport(e)});var t=e.getBoundingClientRect(),e=(window.innerWidth-500)/2,n=(window.innerHeight-500)/2;return t.top<=500+n&&t.bottom>=n&&t.left<=500+e&&t.right>=e}function isBBoxInViewport(e){var e=_slicedToArray(e,4),t=e[0],n=e[1],r=e[2],e=e[3],e=[[t,e],[r,e],[r,n],[t,n]].map(function(e){e=map.projection(e);return{x:e[0],y:e[1]}}),r=Math.min.apply(Math,_toConsumableArray(e.map(function(e){return e.x}))),t=Math.max.apply(Math,_toConsumableArray(e.map(function(e){return e.x}))),n=Math.min.apply(Math,_toConsumableArray(e.map(function(e){return e.y}))),e=Math.max.apply(Math,_toConsumableArray(e.map(function(e){return e.y}))),a=(d3.select("#map-svg").call(map.zoom),map.zoom.scale()),o=map.zoom.translate(),r=o[0]+r*a,t=o[0]+t*a,n=o[1]+n*a,o=o[1]+e*a,e=(window.innerWidth-400)/2,a=(window.innerHeight-400)/2;return!(t<e||400+e<r||o<a||400+a<n)}function displayKeyboardModeMessage(){var e=document.getElementById("keyboard-mode-message"),t=(e.classList.remove("hidden"),document.createElement("div"));t.innerHTML="<h2>Keyboard mode active! <span class='fa fa-keyboard'></span> </h2><p>Type a <kbd>number</kbd> to select a country.<p><p>Move around with <kbd>&#8592;</kbd><kbd>&#8594;</kbd><kbd>&#8593;</kbd><kbd>&#8595;</kbd> keys.</p><p>Zoom out with <kbd>-</kbd> key. </p><p>Toggle audio feedback with <kbd>A</kbd> key.</p>",e.appendChild(t),addViewportBoxIndicator()}function hideKeyboardModeMessage(){var e=document.getElementById("keyboard-mode-message");e.classList.add("hidden"),e.innerHTML="",removeViewportBoxIndicator()}function addViewportBoxIndicator(){removeViewportBoxIndicator();var e=document.createElement("div"),t=(e.id="viewport-box-indicator",(window.innerWidth-400)/2),n=(window.innerHeight-400)/2;e.style.position="fixed",e.style.left=t+"px",e.style.top=n+"px",e.style.width="400px",e.style.height="400px",e.style.border="1px solid rgba(255, 255, 255, 0.6)",e.style.pointerEvents="none",e.style.zIndex="1000",e.style.boxSizing="border-box",window.addEventListener("resize",updateViewportBoxPosition)}function removeViewportBoxIndicator(){var e=document.getElementById("viewport-box-indicator");e&&e.remove(),window.removeEventListener("resize",updateViewportBoxPosition)}function updateViewportBoxPosition(){var e,t,n=document.getElementById("viewport-box-indicator");n&&(e=(window.innerWidth-400)/2,t=(window.innerHeight-400)/2,n.style.left=e+"px",n.style.top=t+"px")}function getPathCenter(e){var t=parseFloat(e.getAttribute("data-center-y"));return{x:-parseFloat(e.getAttribute("data-center-x")),y:-t}}var hasAnnounced=!1;function getVisibleCountries(){var e=d3.selectAll(".country"),t=[];return e.each(function(){t.push(this)}),t.filter(function(e){var t=parseInt(e.id.slice(1));if(EXCLUDED_COUNTRY_IDS.includes(t))return!1;t=utils.getCountryNameFromId(t);return!(!t||"undefined"===t)&&isInViewport(e)})}function getVisibleCountriesSummary(){var e=getVisibleCountries();return"".concat(e.length," ").concat(1===e.length?"country":"countries"," visible, press L to list")}function updateVisibleCountries(e){keyboardMode.cleanup(),visibleCountries=getVisibleCountries(),e&&e.scale()>=MIN_ZOOM_LEVEL_FOR_KEYBOARD_MODE&&(KEYBOARD_MODE_ACTIVE=!0,displayKeyboardModeMessage(),hasAnnounced||(announcer.announce("Keyboard mode active! Press L to hear the list of countries."),hasAnnounced=!0),document.getElementById("controls").classList.add("hidden"),document.getElementById("legend").classList.add("hidden"),document.getElementById("filter-text").classList.add("hidden"),document.getElementById("filter").classList.add("hidden"),document.querySelector(".no-countries").classList.add("hidden"),document.getElementById("friends").classList.add("hidden"),assignNumbersToCountries(),visibleCountries.forEach(function(e){window.addEventListener("keydown",handleNumberKeyPress);var t=getPathCenter(e),n=e.id,r=countryNumberMap[n];d3.select(e.parentElement).append("rect").attr("class","a11y-number-bg").attr("x",t.x-1.5).attr("y",t.y-1.5).attr("width",3).attr("height",3).attr("rx",.5).attr("ry",.5),d3.select(e.parentElement).append("text").attr("class","a11y-number").attr("data-country-id",n).attr("text-anchor","middle").attr("alignment-baseline","middle").attr("x",t.x).attr("y",t.y+.2).text(r),d3.select(e.parentElement).append("text").attr("class","a11y-country-name").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("font-size","0.1rem").attr("x",t.x).attr("y",t.y+4).text(utils.getCountryNameFromId(parseInt(n.slice(1))))}))}function assignNumbersToCountries(){var a=new Set;visibleCountries.forEach(function(e){var t=e.id;if(!countryNumberMap[t]||a.has(countryNumberMap[t]))for(var n=0;n<NUMBER_POOL.length;n++){var r=NUMBER_POOL[n];if(!Object.values(countryNumberMap).includes(r)&&!a.has(r)){countryNumberMap[t]=r,a.add(r);break}}else a.add(countryNumberMap[t])}),Object.keys(countryNumberMap).forEach(function(t){visibleCountries.some(function(e){return e.id===t})||delete countryNumberMap[t]})}function getAnnouncementText(e){var t;return KEYBOARD_MODE_ACTIVE?(t=window.auditoryFeedback&&window.auditoryFeedback.isEnabled(),"".concat(e,". ").concat(getVisibleCountriesSummary(),". ").concat(t?"Press A to turn off audio feedback.":"")):e}keyboardMode.init=function(c,l,d,u,p){keyboardMode.zoomBehavior=c,window.addEventListener("keydown",function(t){if(!document.querySelector("dialog[open]")){var e=window.location.href.split("username=")[1];if(!search.getSearchStatus()&&e){var n=c.translate(),r=c.scale(),a=[d/2,u/2];switch(t.key){case"Escape":if(null!==map.centered)return map.dismissCenteredCountry(),keyboardMode.cleanup(),void d3.select("#map-svg").node().focus();var o=1;n[0]=a[0]+(n[0]-a[0])*o/r,n[1]=a[1]+(n[1]-a[1])*o/r,r=o,t.preventDefault(),l(n,r,!1,!0),keyboardMode.cleanup(),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Escape key",eventLabel:"test"});break;case"ArrowUp":n[1]+=100,t.preventDefault(),l(n,r,!1,!0),getVisibleCountries(),setTimeout(function(){var e=getAnnouncementText("Panning north");announcer.announce(e,"assertive",100)},100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"ArrowUp key",eventLabel:"test"});break;case"ArrowDown":n[1]-=100,t.preventDefault(),l(n,r,!1,!0),getVisibleCountries(),setTimeout(function(){var e=getAnnouncementText("Panning south");announcer.announce(e,"assertive",100)},100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"ArrowDown key",eventLabel:"test"});break;case"ArrowLeft":n[0]+=100,t.preventDefault(),l(n,r,!1,!0),getVisibleCountries(),setTimeout(function(){var e=getAnnouncementText("Panning west");announcer.announce(e,"assertive",100)},100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"ArrowLeft key",eventLabel:"test"});break;case"ArrowRight":n[0]-=100,t.preventDefault(),l(n,r,!1,!0),getVisibleCountries(),setTimeout(function(){var e=getAnnouncementText("Panning east");announcer.announce(e,"assertive",100)},100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"ArrowRight key",eventLabel:"test"});break;case"+":case"-":o="+"===t.key?1.25*r:r/1.25;p<o&&(o=p),n[0]=a[0]+(n[0]-a[0])*o/r,n[1]=a[1]+(n[1]-a[1])*o/r,r=o,t.preventDefault(),l(n,r,!1,!0),updateVisibleCountries(c),setTimeout(function(){var e=getAnnouncementText("Zoom ".concat("+"===t.key?"in":"out"," level ").concat(parseInt(o)));announcer.announce(e,"assertive",100)},100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Zoom in/out",eventLabel:"test"});break;case"h":announcer.announce(document.getElementById("a11y-info-text").textContent,"polite"),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"Help",eventLabel:"test"});break;case"l":if(!KEYBOARD_MODE_ACTIVE)return announcer.announce("Keyboard mode is not active right now. Zoom in to at least level 7 to activate.","assertive",100),void ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"List countries (premature)",eventLabel:"test"});var i="",s=getCurrentlyVisibleCountries();s.sort(function(e,t){return e.number.localeCompare(t.number)}),s.forEach(function(e){i+="".concat(e.number,": ").concat(e.name," (").concat(e.artistCount," artists), ")}),announcer.announce(i,"assertive",100),ga("send",{hitType:"event",eventCategory:"Keyboard",eventAction:"List countries",eventLabel:"test"});break;default:return}null!==map.centered&&map.dismissCenteredCountry(),"ArrowUp"!==t.key&&"ArrowDown"!==t.key&&"ArrowLeft"!==t.key&&"ArrowRight"!==t.key||setTimeout(function(){window.auditoryFeedback&&window.auditoryFeedback.isEnabled()&&window.auditoryFeedback.updateFeedback()},100)}}})},keyboardMode.cleanup=function(){hideKeyboardModeMessage(),KEYBOARD_MODE_ACTIVE=!1,keyboardMode.zoomBehavior&&keyboardMode.zoomBehavior.scale()<MIN_ZOOM_LEVEL_FOR_KEYBOARD_MODE&&(countryNumberMap={}),d3.selectAll(".a11y-number").remove(),d3.selectAll(".a11y-number-bg").remove(),d3.selectAll(".a11y-country-name").remove(),document.getElementById("controls").classList.remove("hidden"),document.getElementById("friends").classList.remove("hidden"),document.getElementById("legend").classList.remove("hidden"),document.getElementById("filter-text").classList.remove("hidden"),document.getElementById("filter").classList.remove("hidden"),document.querySelector(".no-countries").classList.remove("hidden"),window.removeEventListener("keydown",handleNumberKeyPress),removeViewportBoxIndicator()},keyboardMode.isActive=function(){return keyboardMode.zoomBehavior&&keyboardMode.zoomBehavior.scale()>=MIN_ZOOM_LEVEL_FOR_KEYBOARD_MODE},keyboardMode.getStatus=function(){return KEYBOARD_MODE_ACTIVE},keyboardMode.updateVisibleCountries=function(e){updateVisibleCountries(e)},keyboardMode.getCurrentlyVisibleCountries=function(){return getCurrentlyVisibleCountries()};var noCountries=noCountries||{},listOfArtistsWithNoCountry=[],saveToStorage=function(e,t,n){localforage.setItem(e,t,n||function(){})};function sortArtists(e,t){return"scrobbles"===t?e.sort(function(e,t){return t.playcount-e.playcount}):"name"===t?e.sort(function(e,t){return e.artist.localeCompare(t.artist)}):void 0}var announcementIntervalId,STORED_ARTISTS,CACHED_NO_COUNTRIES,addArtistsWithNoCountry=function(e){function o(){var e,t=this.id,n=this.checked,r=JSON.parse(localStorage.getItem("noCountryArtistsProgress"))||{};r[t]={artistName:t,checked:n},localStorage.setItem("noCountryArtistsProgress",JSON.stringify(r)),n&&null!==(e=document.querySelector("#hide-checked"))&&void 0!==e&&e.checked&&(this.parentNode.style.display="none",(t=this.parentNode.nextElementSibling.querySelector("input"))&&t.focus()),document.querySelector("label[for='hide-checked']").innerHTML="Hide checked artists (".concat(document.querySelectorAll("dialog[open] ul li input[type='checkbox']:checked").length,")"),ga("send",{hitType:"event",eventCategory:"No countries",eventAction:"Check artist as done",eventLabel:"test"})}function a(){var r=JSON.parse(localStorage.getItem("noCountryArtistsProgress"))||{},e=sortArtists(listOfArtistsWithNoCountry,noCountryArtistSortMethod),a=d3.select(".no-countries__content ul");a.html(""),e.forEach(function(e){var t=r[e.artist]||{artistName:e.artist,checked:!1},n=a.append("li");n.append("input").attr("type","checkbox").property("checked",t.checked).attr("id",e.artist).on("change",o),n.append("label").attr("for",e.artist).html('<a href="'+e.url+'" target="blank" class="no-countries__link">'+e.artist+'</a><span class="no-countries__secondary">'+e.playcount+" scrobbles</span>"),null!==(e=document.querySelector("#hide-checked"))&&void 0!==e&&e.checked&&t.checked&&n.style("display","none")}),d3.select(".no-countries__info").html(listOfArtistsWithNoCountry.length+" artists without a country:")}listOfArtistsWithNoCountry=listOfArtistsWithNoCountry.concat(e),saveToStorage("no_countries",listOfArtistsWithNoCountry),d3.select("#hide-checked").node()||d3.select("label[for='hide-checked']").node()||(d3.select("dialog fieldset").append("input").attr("type","checkbox").attr("id","hide-checked").on("change",a),d3.select("dialog fieldset").append("label").attr("for","hide-checked").text("Hide checked artists"));var i=document.getElementsByName("sort");function t(){var e,t,n=_createForOfIteratorHelper(i);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.checked){e=r.value,noCountryArtistSortMethod=e,a();break}}}catch(e){n.e(e)}finally{n.f()}ga("send",{hitType:"event",eventCategory:"No countries",eventAction:"Sort artists",eventLabel:"test"})}var n,r=_createForOfIteratorHelper(i);try{for(r.s();!(n=r.n()).done;)n.value.addEventListener("change",t)}catch(e){r.e(e)}finally{r.f()}a(),document.querySelector(".no-countries__title").addEventListener("click",function(){document.querySelector(".no-countries__content").showModal(),document.querySelector("#no-countries__heading").focus(),document.querySelector("label[for='hide-checked']").innerHTML="Hide checked artists (".concat(document.querySelectorAll("dialog[open] ul li input[type='checkbox']:checked").length,")"),document.addEventListener("keydown",function(e){27==e.keyCode&&(document.querySelector(".no-countries__content").close(),document.querySelector(".no-countries__title").focus())}),ga("send",{hitType:"event",eventCategory:"No countries",eventAction:"Open dialog",eventLabel:"test"})}),document.querySelector(".no-countries__content .close").addEventListener("click",function(){document.querySelector(".no-countries__content").close(),document.querySelector(".no-countries__title").focus()});var s=document.querySelector(".no-countries__content");s.addEventListener("click",function(e){e.target===s&&s.close()}),listOfArtistsWithNoCountry.length&&setTimeout(function(){document.querySelector(".no-countries").classList.remove("hidden")},850)},script=(noCountries.addArtistsWithNoCountry=addArtistsWithNoCountry,script||{}),loadingReady=!1,loadingStatus=loadingReady?"Ready to Explr!":"Loading...",noCountryArtistSortMethod="scrobbles",STORED_ARTISTS_PROMISE=localforage.getItem("artists").then(function(e){return STORED_ARTISTS=e||{}}),CACHED_NO_COUNTRIES_PROMISE=localforage.getItem("no_countries").then(function(e){return CACHED_NO_COUNTRIES=e||{}}),USER_TAGS=[],CACHED_USERS=JSON.parse(window.localStorage.cached_users||"{}"),SESSION={};function clearExplrCache(){var e=window.localStorage.getItem("theme");return window.localStorage.clear(),window.localStorage.setItem("theme",e),announcer.announce("Cleared artist cache, reloading page..."),localforage.clear()}var legend,countryCountObj={},map=(!function(){function r(){loadingReady=!1,api.lastfm.send("library.getartists",[["user",i],["limit",50],["page",o]],function(e,t){if(""===t)return console.error('Got empty string ("") as response, skipping page.'),o++,void r();if(e||t.error)return console.error("Error in getAllArtists, page "+o,e,t),void(s++<5?r():confirm("Last.fm took too long to respond.\n\nPress OK to refresh the page and try again, or Cancel to use the page as it is.")&&clearExplrCache().then(function(){l("artists",STORED_ARTISTS,function(){window.location.reload()})}));if(s=0,1===o&&(SESSION.total_artists=+t.artists["@attr"].total,a=+t.artists["@attr"].totalPages,0===SESSION.total_artists))return d3.select(".bubblingG").remove(),d3.select("#loading-text").html("You haven't listened to any<br> artists yet. Start scrobbling with <br>                                                        <a href='http://evolver.fm/2012/05/08/how-to-scrobble-to-last-fm-from-itunes-spotify-and-more/'>your favorite music player!</a>"),void d3.select(".loader").style("pointer-events","all");o++;var n=[];t.artists.artist.forEach(function(e){var t=STORED_ARTISTS[e.name]||{};t.playcount=+e.playcount,t.url=e.url,STORED_ARTISTS[e.name]=t,n.push(e.name)}),l("artists",STORED_ARTISTS),api.getCountries(n,function(e){var t=d3.nest().key(function(e){return e.id}).rollup(function(e){return e}).map(e);d3.keys(t).forEach(function(e){countryCountObj[e]=countryCountObj[e]||{},countryCountObj[e][i]=countryCountObj[e][i]||[];var n=countryCountObj[e][i];(n=n.concat(t[e])).forEach(function(e,t){n[t].url=STORED_ARTISTS[e.artist].url,n[t].playcount=STORED_ARTISTS[e.artist].playcount}),countryCountObj[e][i]=n}),noCountries.addArtistsWithNoCountry(e.filter(function(e){return!e.id})),map.addArtists(t),(a<o?c:r)()})})}function n(e,t){(e||t.error)&&t&&6===t.error&&(alert("User not found"),window.location.assign(window.location.origin+window.location.pathname));var i=0,s={},c=t.topartists.artist;c.forEach(function(e,t){setTimeout(function(){api.lastfm.send("artist.gettoptags",[["artist",e.name]],function(e,t){var r,n=t.toptags&&t.toptags.tag;if(n)for(var a=Math.min(n.length,10),o=0;o<a;o++)s[n[o].name]?s[n[o].name]++:s[n[o].name]=1;++i==c.length-1&&(USER_TAGS=[],r=["american","swedish","british","female vocalists","male vocalists","german","seen live","english","singer-songwriter","spanish","french"],d3.keys(s).forEach(function(e){for(var t=!1,n=0;n<r.length;n++)e===r[n]&&(t=!0);t||USER_TAGS.push({tag:e,count:s[e]})}),USER_TAGS.sort(function(e,t){return t.count<e.count?-1:t.count>e.count?1:0}),console.info("Done getting tags, saved to localStorage.user_tags"),window.localStorage.user_tags=JSON.stringify(USER_TAGS))})},3e3*Math.random())})}var i,a,o=1,s=0,e=["Malawi","Malaysia","Peru","Sierra Leone","Trinidad & Tobago","Greece","Laos","Iran","Haiti","Nicaragua","Mongolia","Slovakia"],c=function(){loadingReady=!0,clearInterval(announcementIntervalId),announcer.announce("All artists have been loaded!");var e=document.querySelector("#map-container svg"),t=e.getAttribute("aria-labelledby"),n=(e.setAttribute("aria-labelledby","".concat(t," progress-text sr-instructions")),d3.select(".loader"));n.transition().duration(2e3).style("opacity",0).each("end",function(){n.remove()}),d3.select("#progress-text").transition().delay(5e3).duration(1500).style("opacity",0),(CACHED_USERS={})[i]=(new Date).getTime(),window.localStorage.cached_users=JSON.stringify(CACHED_USERS),window.localStorage.countryCountObj=JSON.stringify(countryCountObj)},t=window.location.href.split("username=")[1],l=(t?(document.addEventListener("DOMContentLoaded",function(e){document.getElementById("search-button").addEventListener("click",function(){setTimeout(function(){search.initSearch()},0)})}),window.addEventListener("keydown",function(e){if(!e.ctrlKey&&!e.metaKey||70!==e.keyCode||e.shiftKey||keyboardMode.getStatus()||(console.log(keyboardMode.getStatus()),e.preventDefault(),search.initSearch()),!search.getSearchStatus()&&!keyboardMode.getStatus())switch(e.keyCode){case 83:screenshot.render(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Take screenshot",eventLabel:"test"});break;case 84:nextTheme(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Cycle theme",eventLabel:"test"})}}),15<t.length&&(t=t.substr(0,15)),i=t,SESSION.name=t,Promise.all([CACHED_NO_COUNTRIES_PROMISE,STORED_ARTISTS_PROMISE]).then(function(){return ga("send","event","splash screen","Go!","test"),document.getElementById("map-label").innerHTML="".concat(i,"'s world map"),(t=d3.select("#welcome-container")).transition().duration(2e3).style("opacity",0).each("end",function(){t.remove()}),d3.select(".loader").transition().duration(2e3).style("opacity",1),d3.select("#loading-text").html("Getting library..."),setTimeout(function(){var e;announcer.announce(null===(e=document.getElementById("loading-text"))||void 0===e?void 0:e.innerText)},6e3),setTimeout(function(){var e;"Getting library..."===(null===(e=d3.select("#loading-text"))||void 0===e?void 0:e.html())&&(d3.select("#loading-text").html("Last.fm is taking<br>a long time to<br>respond..."),setTimeout(function(){"Last.fm is taking<br>a long time to<br>respond..."===d3.select("#loading-text").html()&&d3.select("#loading-text").html("Maybe <a href='http://last.fm' target='_blank'>last.fm</a> has<br>gone offline...").style("pointer-events","all")},8e3))},8e3),document.getElementById("a11y-map-info").classList.remove("hidden"),d3.selectAll(".on-map-view").style({visibility:"visible"}),api.lastfm.send("user.gettopartists",[["user",i],["period","12months"],["limit","50"]],n),api.getFriends(function(e,t){try{var n=t.friends.user,r=0,a=d3.select("#friend-name"),o=function(){a.html(""),a.append("a").attr({href:window.location.origin+window.location.pathname+"?username="+n[r].name,target:"_self"}).html(n[r].name)};d3.selectAll(".arrow").on("click",function(){r=d3.select(this).classed("left")?0===r?n.length-1:r-1:(r+1)%n.length,o()}),o(),d3.select("#friends #msg").html("Check out "+i+"'s friends"),d3.select("#friends").transition().duration(1e3).style("opacity",1)}catch(e){console.error("getFriends()",e),d3.select("#friends").html("&nbsp;Couldn't find any<br>friends on last.fm :(&nbsp;"),d3.select("#friends").transition().duration(1e3).style("opacity",1)}}),void(CACHED_USERS[i]?(console.info("No new artists on last.fm!"),countryCountObj=JSON.parse(window.localStorage.countryCountObj),localforage.getItem("no_countries",function(e,t){noCountries.addArtistsWithNoCountry(t||[])}),api.lastfm.send("library.getartists",[["user",i],["limit",1],["page",1]],function(e,t){SESSION.total_artists=+t.artists["@attr"].total}),setTimeout(function(){map.addArtists(Object.keys(countryCountObj).reduce(function(e,t){return _objectSpread(_objectSpread({},e),{},_defineProperty({},t,countryCountObj[t][SESSION.name]))},{})),c()},1e3)):(e=window.localStorage.theme,window.localStorage.clear(),e&&(window.localStorage.theme=e),r()));var e,t})):(d3.select("#welcome-container").style("visibility","visible"),d3.select("#randomCountry").html(e[Math.floor(Math.random()*e.length)]+"?")),function(e,t,n){localforage.setItem(e,t,n||function(){})})}(),script.getCurrentData=function(){return loadingReady?JSON.parse(window.localStorage.getItem("countryCountObj")):countryCountObj},script.getLoadingStatus=function(){return loadingStatus},script.setLoadingStatus=function(e){loadingStatus=e},{}),colorArray=["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],countryScore=0,currentPage=1,itemsPerPage=5,artists=[],currentZoom=1,MAX_ZOOM=25,prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,COUNTRY_BBOX_OVERRIDES={840:[[-125,24,-66,50],[-180,51,-130,72],[-160,18,-154,23]],643:[[27.5,41,180,82],[-180,60,-169,71]],152:[[-75.6,-55.9,-66,-17.5],[-109.5,-27.2,-109.2,-27],[-80.8,-33.8,-80,-33.3]],218:[[-81.5,-5,-75,1.5],[-92,-1.4,-89.2,1.7]],724:[[-9.3,36,3.4,43.8],[-18.2,27.6,-13.3,29.5],[1.2,38.6,4.4,40.1]],620:[[-9.5,36.8,-6.2,42.2],[-31.3,32.6,-16.2,39.7]],250:[[-5.1,41.3,9.6,51.1],[-54.6,2.1,-51.6,5.8],[55.2,-21.4,55.8,-20.8],[-61.2,14.4,-60.8,14.9],[-61.8,15.8,-61,16.5],[8.5,41.3,9.6,43]],528:[[3.3,50.7,7.2,53.6],[-69.2,12,-68.2,12.4],[-69,11.9,-68.2,12.4],[-63.2,17.9,-62.9,18.1]],554:[[166,-47.5,179,-34],[172.5,-43.9,173.9,-40.5]],242:[[177,-21,180,-16],[-180,-21,-178,-16]],296:[[172,-3,177,5],[-175,-11.5,-170,-5],[-160,-5,-150,12]]};map.COUNTRY_BBOX_OVERRIDES=COUNTRY_BBOX_OVERRIDES,window.lastInputWasKeyboard=!1,window.addEventListener("keydown",function(e){([37,38,39,40,65,76,27,13,32].includes(e.keyCode)||"0"<=e.key&&e.key<="9")&&(window.lastInputWasKeyboard=!0)}),window.addEventListener("mousedown",function(){window.lastInputWasKeyboard=!1}),window.addEventListener("click",function(){window.lastInputWasKeyboard=!1}),window.addEventListener("wheel",function(){window.lastInputWasKeyboard=!1}),function(m,f){d3.select(m).on("resize",function(){m.clearTimeout(x),x=m.setTimeout(function(){P(!0),j([0,0],1)},200)});var c,l,a,u,g,o,y,b,p,v,w,i="artists",s=d3.behavior.zoom().scaleExtent([1,MAX_ZOOM]).on("zoom",j),h={},C=!1,d=[0,1,2,3,4,5,6],r=1,E=0,e=m.matchMedia("(prefers-color-scheme: dark)").matches?"blue_black":"pink_white",n=m.localStorage.theme||e;function t(){c=m.innerHeight-5,l=f.getElementById("map-container").offsetWidth}function S(e){if(h[e.id]){for(var t=0,n=0;n<h[e.id].length;n++)t+=h[e.id][n].playcount;return t}return 0}function A(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}function k(){var e=-1;switch(i){case"artists":for(var e=r,t=0;t<5;t++)d[t]=Math.pow(Math.E,Math.log(e)/6*(t+1));d=[0,1,d[0],d[1],d[2],d[3],d[4]];break;case"scrobbles":e=E;for(var n=0;n<7;n++)d[n]=Math.pow(Math.E,Math.log(e)/7*(n+1));d=[0,1,d[1],d[2],d[3],d[4],d[5]]}v=d3.scale.threshold().domain(d).range(colorArray)}function T(){for(var e=0,t=d.length;e<t;)d[e]=Math.ceil(d[e]),e++;var r=[A(d[0])+"",d[1]+"-"+(d[2]-1),d[2]+"-"+(d[3]-1),d[3]+"-"+(d[4]-1),d[4]+"-"+A(d[5]-1),A(d[5])+"-"+A(d[6]-1),"> "+A(d[6])],e=(o.select("g#legend").selectAll("g.legend").remove(),legend=o.select("g#legend").selectAll("g.legend").data(d),.03*l),n=.03*c,a=o.select("#filter-text").attr("x",e).attr("y",c-n-20*d.length-30).text("Number of "),a=(o.select("#filter").attr("x",e+a[0][0].getComputedTextLength()+5).attr("y",c-n-20*d.length-30).text(i).on("click",function(){i="artists"===i?"scrobbles":"artists",P()}),d3.select(".no-countries").style("bottom",n+20*d.length+30+30+"px"),legend.enter().append("g").attr("class","legend"));a.append("rect").attr("x",e).attr("y",function(e,t){return c-20*t-40-n}).attr("width",20).attr("height",20).style("fill",function(e){return v(e)}),a.append("text").attr("x",e+30).attr("y",function(e,t){return c-20*t-20-4-n}),legend.selectAll("text").data(d).text(function(e,t,n){return r[n]})}map.drawPlays=function(){i="scrobbles",P()},d3.json("assets/data/playlists.json",function(e,t){w=t});var _,O,L,x,I=d3.select("#map-container").append("div").attr("class","tooltip hidden").attr("aria-hidden","true"),R=d3.select("main").append("div").attr("class","infoContainer hidden").attr("id","infoContainer").attr("role","region").attr("aria-labelledby","music-from cname-heading"),M=d3.select("#infoContainer").append("div").attr("class","cnameDiv").attr("id","cname"),N=(d3.select("#infoContainer").append("div").attr("class","artistContainer").attr("id","artistContainer"),d3.select("#artistContainer").append("div").attr("class","detailsDiv").attr("id","details"),d3.select("#artistContainer").append("div").attr("class","recoDiv").attr("id","recommendations"),d3.select("#artistContainer").append("div").attr("class","artistSummaryDiv").attr("id","summary"),{blue_black:["#03020D","#140E1F","#2A075A","#321C78","#362688","#3E3CA7","#4651C5","#5371F4"],green_black:["#03020D","#08120C","#032F30","#064137","#0E6745","#158C54","#1CB162","#28EA78"],pink_black:["#03020D","#1F0310","#4B0627","#5C1138","#7E285C","#A13F80","#C355A4","#F778DA"],pink_white:["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],green_white:["#ece2f0","#F6EBFA","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c"],red_white:["#F0F0D8","#F0F0D8","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"]}),e=m.nextTheme=function(e){var t=d3.keys(N),e=(n=e||t[(t.indexOf(n)+1)%t.length],colorArray=N[n],["blue_black","green_black","pink_black"].includes(n)?"dark":"light");e+=" "+n,d3.select(f.body).attr("class",e),m.localStorage.theme=n,a&&P(),announcer.announce("Theme changed to ".concat(n))};function D(e,t){u=d3.geo.naturalEarth().translate([e/2,t/2+.08*t]).scale(e/1.7/Math.PI),g=d3.geo.path().projection(u),map.path=g,map.projection=u,o=d3.select("#map-container").attr("role","application").append("svg").attr("role","img").attr("tabindex","0").attr("aria-labelledby","map-label").attr("id","map-svg").attr("width",e).attr("height",t).style("margin-left",f.getElementById("map-container").offsetWidth/2-e/2).call(s).on("click",F).append("g"),y=o.append("g"),o.append("g").attr("id","legend"),o.append("text").attr({id:"filter-text",class:"legend"}),o.append("text").attr({id:"filter",class:"legend"}),map.zoom=s}function B(e,t){e=y.selectAll(".country").data(e);d3.select("#progress-bar").style({height:countryScore/210*100+"%","background-color":colorArray[6]});d3.select("#countryCount").style({"background-color":colorArray[1],"border-color":colorArray[6]}).on("mousemove",function(){d3.select("#progress-text").transition().duration(prefersReducedMotion?0:150).style("opacity",.9)}).on("mouseout",function(){d3.select("#progress-text").transition().duration(prefersReducedMotion?0:150).style("opacity",0)}),d3.select("#progress-text").html("Scrobbled from "+countryScore+"/210 countries").attr("aria-hidden","true"),t&&e.enter().insert("path").attr("class","country").attr("d",g).attr("id",function(e,t){return"c".concat(e.id)}).attr("title",function(e,t){return e.properties.name}).attr("data-center-x",function(e,t){return G(e).x}).attr("data-center-y",function(e,t){return G(e).y}).style("fill",function(){return v(0)}).style("transform-origin",function(e){e=G(e);return"".concat(-e.x,"px ").concat(-e.y,"px")}),e.transition().style("fill",function(e){switch(i){case"artists":return h[e.id]?v(h[e.id].length):v(0);case"scrobbles":return v(S(e))}}),O=f.getElementById("map-container").offsetLeft,L=f.getElementById("map-container").offsetTop,e.on("mousemove",function(n,e){b.forEach(function(e,t){e.id===n.id&&(r=e.name,e.tag)});var r,t=d3.mouse(o.node()).map(function(e){return parseInt(e)});I.classed("hidden",!1).attr("style","left:"+(t[0]+O+20)+"px;top:"+(t[1]+L+10)+"px").html(r+(h[n.id]?"<br>"+h[n.id].length+" artists, "+A(S(n))+" scrobbles":""))}).on("mouseout",function(e,t){I.classed("hidden",!0)}).on("click",function(n,e){z(n),b.forEach(function(e,t){e.id===n.id&&(e.name,e.tag,n.id)}),d3.mouse(o.node()).map(function(e){return parseInt(e)});_.on("click",function(e,t){q(),z(p),d3.select("#map-svg").node().focus()})})}function P(e){t(),e&&(d3.select("#map-svg").remove(),D(l,c)),r=d3.max(d3.keys(h),function(e){return h[e].length}),E=d3.max(d3.keys(h),function(e){return S({id:e})}),k(),T(),B(a,e)}function j(e,t,n,r){MIN_ZOOM_LEVEL_FOR_KEYBOARD_MODE<=t&&m.lastInputWasKeyboard?keyboardMode.updateVisibleCountries(s):keyboardMode.cleanup();var a=e||!!d3.event&&d3.event.translate||s.translate(),o=t||!!d3.event&&d3.event.scale||s.scale(),e=(e||t||!p||(Y(!1),q(),p=null),c/4);a[0]=Math.min(l/c*(o-1),Math.max(1.2*l*(1-o),a[0])),a[1]=Math.min(e*(o-1)+e*o,Math.max(c*(1-o)-e*o,a[1])),s.translate(a),s.scale(o),(n?y.transition().duration(prefersReducedMotion?0:950):y).attr("transform","translate("+a+")scale("+o+")"),d3.selectAll(".country").style("stroke-width",1.5/o),m.triggerAuditoryFeedback()}function F(){u.invert(d3.mouse(this))}function V(e,t){e=(e-1)*t,e=artists.slice(e,e+t);d3.selectAll(".artist-li").remove(),e.forEach(function(e){var t=d3.select("#top-artist-list").append("li").attr("class","artist-li").append("button").attr({class:"scrobbled artist-div lowlight","data-artist":e.artist}).on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),d3.selectAll(".artist-div").attr("aria-pressed","false"),d3.select(this).attr("aria-pressed","true"),W(d3.select(this).attr("data-artist"))});t.append("div").style("display","block").append("div").attr("class","artist-image image-div"),t.append("div").attr("class","play-count-div").append("p").html("<strong>"+e.artist+"</strong><br>"+e.playcount+" scrobbles").attr("class","details-p")}),d3.select(".artist-control.left").attr("disabled",1===currentPage?"disabled":null),d3.select(".artist-control.right").attr("disabled",currentPage===Math.ceil(artists.length/t)?"disabled":null)}function U(){currentPage<artists.length/itemsPerPage&&(V(++currentPage,itemsPerPage),announcer.announce("Showing next five artists","polite"),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Next five",eventLabel:"test"}))}function H(){1<currentPage&&(V(--currentPage,itemsPerPage),announcer.announce("Showing previous five artists","polite"),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Previous five",eventLabel:"test"}))}function K(s){C=!0,b.forEach(function(e,t){e.id===s.id&&(c=e.name,l=e.tag,n=(e.names||[e.name]).map(function(e){return'<span class="demonym">'+e+"</span>"}).join(", "),r=(e.tags||[e.tag]).map(function(e){return'<span class="demonym">'+e+"</span>"}).join(", "))}),d3.select("#recommendations").html(""),R.classed("hidden",!1).transition().style("opacity",1).duration(prefersReducedMotion?0:750),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!0),_=d3.select("#infoContainer").append("button").attr("type","button").attr("aria-label","Close ".concat(c)).attr("class","close-button fa fa-xmark"),M.append("div").attr("class","cnameContainer").attr("id","cnameCont").append("h1").html(c).attr("id","cname-heading"),d3.select("#cnameCont").append("strong").html(function(){return h[s.id]?A(h[s.id].length)+" artists, "+A(S(s))+" scrobbles":"No artists yet - Find new here<span aria-hidden> -></span>"});var c,l,n,r,e=w.find(function(e){return e.name===c}),t=d3.select("#cnameCont").append("div").attr("class","playlist-link"),a=t.append("a").attr("href","https://last.fm/tag/"+c),d=(a.append("img").attr("alt","Last.fm tag").attr("class","playlist-link__img").attr("src","https://www.shareicon.net/data/32x32/2016/05/24/769923_logo_512x512.png").attr("style","background:none"),a.append("span").html("#"+c),e&&(t.append("span").attr("class","divider").html("/").attr("aria-hidden","true"),(a=t.append("a").attr("href",e.uri).attr("target","_self")).append("img").attr("alt","Spotify playlist").attr("class","playlist-link__img").attr("src","https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg"),a.append("span").html(e.playlistName)),h[s.id]&&(d3.select("#details").append("h2").html("<span>Your top artists tagged with </span>"+n+"<span> or </span>"+r+"<span>: </span>").attr("class","topartists-desc").attr("id","top-artist-list-heading"),currentPage=1,itemsPerPage=5,artists=h[s.id],d3.select("#details").append("div").attr("id","top-artist-list-container"),d3.select("#top-artist-list-container").append("ol").attr("id","top-artist-list").attr("aria-labelledby","top-artist-list-heading"),d3.select("#top-artist-list-container").append("button").attr("class","fa artist-control left fa-angle-left").attr("aria-label","Previous five artists"),d3.select("#top-artist-list-container").append("button").attr("class","fa artist-control right fa-angle-right").attr("aria-label","Next five artists"),d3.select(".artist-control.left").on("click",H),d3.select(".artist-control.right").on("click",U),V(currentPage,itemsPerPage)),d3.select("#recommendations").append("h2").html("You may like: ").attr("id","recom-heading").attr("class","topartists-desc"),d3.select("#recommendations").append("ul").attr("id","recom-list").attr("aria-labelledby","recom-heading").classed("hidden",!1),d3.select("#recommendations").append("div").attr("class","recLoadingDiv")),u=d.append("span").attr("id","rec-loading").html("Looking for artists tagged #"+l);d.append("img").attr({id:"rec-loading-img",src:"assets/img/loader_horizontal.gif",alt:"Loading..."}).style({display:"inline-block",margin:"0 5px"}),d.append("span").attr("id","rec-loading-current"),api.getRecommendations(l,function(i){p&&p.id===s.id&&(u.html("Looking for artists tagged #"+c),api.getRecommendations(c,function(e){if(p&&p.id===s.id){u.html("Loading images for recommended artists");for(var t,n=i.concat(e),r={},a=0;a<n.length;a++)r[n[a].name]=n[a];for(t in n=new Array,r)n.push(r[t]);n.sort(function(e,t){return t.count<e.count?-1:t.count>e.count?1:0}),0===(n=function(e){for(var t=e.length-1;0<t;t--){var n=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[n],e[n]=r}return e}(n=n.slice(0,20))).length&&(d.remove(),d3.select("#recommendations").append("p").html("We couldn't find any good "+l+" recommendations for you :-( "),d3.select("#recommendations").append("a").attr({href:"https://www.last.fm/tag/"+c,target:"_blank"}).html("Try searching last.fm yourself!"));for(var o=0;o<Math.min(n.length,5);o++){if(p.id!==s.id)return;api.getArtistInfo(n[o].name,function(e){d.remove();e[0].url;var t=e[0].image,n=e[0].name,e=d3.select("#recom-list").append("li").insert("button","#summaryText").attr("type","button").attr("class","artist-div lowlight");e.append("div").style("display","block").append("div").attr("class","image-div").style("background-image","url('"+t+"')"),e.append("div").attr("class","recoArtistInfoDiv").append("p").html(n).attr("class","details-p"),e.on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),W(n)})})}}}))})}function q(){C=!1,api.cancelRecommendationRequests(),R.transition().style("opacity",0).duration(prefersReducedMotion?0:1e3),R.classed("hidden",!0),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!1),d3.select("#details").html(""),d3.select("#recommendations").html(""),d3.select("#cname").html(""),d3.selectAll(".artist-control").remove(),d3.select(".close-button").remove(),d3.selectAll("#top-artist-list").remove()}function W(l){var d,u=[],p=(d3.select("#summaryText").remove(),d3.select("#recommendations").append("div").attr("class","summaryText").attr("id","summaryText"));d3.select("#summaryText").append("span").html("Loading description of "+l),d3.select("#summaryText").append("img").attr({id:"sum-loading-img",src:"assets/img/loader_horizontal.gif"}).style({display:"inline-block",margin:"0 5px"}),api.getArtistInfo(l,function(e){var t=e[0].description.split(/(\n)+/g);d=e[0].tags;for(var n=0;n<15;n++)for(var r=0;r<d.length;r++)d[r]===USER_TAGS[n].tag&&u.push(USER_TAGS[n].tag);var a=(a=u.concat(d)).filter(function(e,t){return a.indexOf(e)==t});d3.select("#summaryText").html("");for(var e=.9*m.innerHeight-f.getElementById("artistContainer").offsetHeight,o=(p.style("max-height",e+"px"),p.append("h2").html(l).attr("id","artistname"),p.append("ul").attr("class","taglist").attr("aria-labelledby","tags-for artistname")),i=0;i<Math.min(a.length,6);i++)for(var s=o.append("li").attr("class","tagdiv").html(a[i]),c=0;c<u.length;c++)a[i]===u[c]&&s.classed("usertag",!0);t.forEach(function(e){p.append("p").html(e||"No description available - <a href='https://last.fm/music/"+l+"' target='_blank'>check out last.fm.</a>")})})}function Y(e,t){d3.selectAll(".country").classed("highlighted",!1),e?(d3.selectAll(".country").transition().style("opacity",function(){return this.id==="c".concat(t.id)?1:.3}),d3.select(f.getElementById("c".concat(t.id))).classed("highlighted",!0)):d3.selectAll(".country").transition().style("opacity",1)}function z(t){m.keyboardMode&&m.keyboardMode.getStatus&&m.keyboardMode.getStatus()&&m.keyboardMode.cleanup();var e,n,r,a=g.bounds(t),o=(S(t),a[1][0]-a[0][0]),i=a[1][1]-a[0][1];if(o<80&&(o=80),t&&p!==t)switch(p=t,q(),K(t),Y(!0,t),announcer.announce("Opened ".concat(b.find(function(e){return e.id===t.id}).name),"assertive"),t.id){case 840:e=-(a[1][0]+a[0][0])/(r=3),n=-(a[1][1]+a[0][1])/1.7;break;case 250:r=7.012,e=-(a[1][0]+a[0][0])/1.85,n=-(a[1][1]+a[0][1])/3;break;case 528:r=12.0124,e=-(a[1][0]+a[0][0])/1.56,n=-(a[1][1]+a[0][1])/2.7;break;case 643:r=1.9,e=-(a[1][0]+a[0][0])/1.25,n=-(a[1][1]+a[0][1])/2;break;case 554:r=4,e=-(a[1][0]+a[0][0])/.9,n=-(a[1][1]+a[0][1])/1.8;break;case 36:r=3.3,e=-(a[1][0]+a[0][0])/1.8,n=-(a[1][1]+a[0][1])/2.1;break;default:r=.55/Math.max(o/l,i/c),e=-(a[1][0]+a[0][0])/2-l/r/4,n=-(a[1][1]+a[0][1])/2}else announcer.announce("Left ".concat(b.find(function(e){return e.id===t.id}).name),"assertive"),e=-l/2,n=-c/2-.08*c,r=1,q(),Y(!1),p=null,f.getElementById("map-svg").focus({preventScroll:!0});var s=u.translate();j([s[0]+e*r,s[1]+n*r],r,!prefersReducedMotion)}function G(e){var t,n,r,a,o,i=e.id;if(COUNTRY_BBOX_OVERRIDES&&COUNTRY_BBOX_OVERRIDES[i])return i=COUNTRY_BBOX_OVERRIDES[i],i=Array.isArray(i[0])?i[0]:i,t=(i=_slicedToArray(i=i,4))[0],n=i[1],t=[(r=i[2])<t?(t+r+360)/2%360:(t+r)/2,(i[3]+n)/2],{x:-(r=u(t))[0],y:-r[1]};var s=g.bounds(e);switch(e.id){case 840:a=-(s[1][0]+s[0][0])/4,o=-(s[1][1]+s[0][1])/1.9;break;case 250:a=-(s[1][0]+s[0][0])/1.94,o=-(s[1][1]+s[0][1])/2.81;break;case 528:a=-(s[1][0]+s[0][0])/1.605,o=-(s[1][1]+s[0][1])/2.54;break;case 643:a=-(s[1][0]+s[0][0])/1.4,o=-(s[1][1]+s[0][1])/2;break;case 554:a=-(s[1][0]+s[0][0])/1.03,o=-(s[1][1]+s[0][1])/1.87;break;case 36:a=-(s[1][0]+s[0][0])/2,o=-(s[1][1]+s[0][1])/2.1;break;default:a=-(s[1][0]+s[0][0])/2,o=-(s[1][1]+s[0][1])/2}return{x:a,y:o}}(map.nextTheme=e)(n),k(),t(),D(l,c),keyboardMode.init(s,j,l,c,MAX_ZOOM),api.getCountriesData().then(function(e){return map.countryNames=b=e}),d3.json("assets/data/world-50m.json",function(e,t){t=topojson.feature(t,t.objects.countries).features;B(a=t,!0)}),map.move=j,m.addEventListener("keydown",function(e){"Escape"!==e.key&&27!==e.keyCode||!C||(console.log("Escape pressed"),q(),z(p))}),map.addArtists=function(e){var t,n,r;Object.entries(e).forEach(function(e){var e=_slicedToArray(e,2),t=e[0],e=e[1];h[t]=(h[t]||[]).concat(e)}),countryScore=0,d3.keys(h).forEach(function(e){countryScore+=1}),a&&P(),m.countryScore=countryScore,t=e,n=m.matchMedia("(prefers-reduced-motion: reduce)").matches,r=y.selectAll(".country").filter(function(e){return!!t[e.id]}),setTimeout(function(){n||r.transition().duration(200).style("opacity","0.8").delay(function(e,t){return 100*t}).transition().duration(150).style("opacity","1")})},map.getCountryCenter=G,map.makeSummaryDiv=W,map.showArtists=V,map.searchArtist=function(t){var e=artists.findIndex(function(e){return e.artist.toLowerCase()===t.toLowerCase()});-1!==e&&(V(currentPage=Math.floor(e/itemsPerPage)+1,itemsPerPage),setTimeout(function(){var e=f.querySelector('[data-artist="'.concat(t,'"]'));null!=e&&e.click(),setTimeout(function(){null!=e&&e.focus()},50)},250))},map.centered=p,map.dismissCenteredCountry=function(){q(),Y(!1),p=null},map.toggleFilter=function(){i="artists"===i?"scrobbles":"artists",T(),P()},f.addEventListener("artistsLoaded",function(){m.auditoryFeedback&&m.auditoryFeedback.updateFeedback()}),m.triggerAuditoryFeedback=function(){m.auditoryFeedback&&m.auditoryFeedback.updateFeedback()},map.getColorDomain=function(){return d}}(window,document);
//# sourceMappingURL=sourcemaps/all.min.js.map
